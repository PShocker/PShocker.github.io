<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pshocker.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Shocker">
<meta property="og:url" content="https://pshocker.github.io/page/2/index.html">
<meta property="og:site_name" content="Shocker">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shocker">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://pshocker.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shocker</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shocker</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">小米12(pro)内核模块编译--环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 13:47:10 / 修改时间：17:41:23" itemprop="dateCreated datePublished" datetime="2022-04-27T13:47:10+08:00">2022-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>很早之前，我看到过一份珍贵无比的代码<br>
<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-259317.htm">开源一个 Linux 内核里进程内存管理模块源码</a></p>
<p>github 地址:<br>
<a target="_blank" rel="noopener" href="https://github.com/abcz316/rwProcMem33">https://github.com/abcz316/rwProcMem33</a></p>
<p>涉及到<strong>内核读写，硬件断点</strong>，很强势！</p>
<p>直接开干就完事了.</p>
<p>我的编译环境:wsl (Ubuntu 18.04)</p>
<h2 id="下载源代码编译工具"><a class="markdownIt-Anchor" href="#下载源代码编译工具"></a> 下载源代码，编译工具</h2>
<p>参考:<br>
<a target="_blank" rel="noopener" href="https://github.com/MiCode/Xiaomi_Kernel_OpenSource/issues/957">https://github.com/MiCode/Xiaomi_Kernel_OpenSource/issues/957</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev unzip openjdk-8-jdk language-pack-zh-hans</span><br></pre></td></tr></table></figure>
<p>下载小米 12 内核源码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b zeus-s-oss</span><br></pre></td></tr></table></figure>
<p>如果没有代理，不建议 git clone, 因为太慢了.</p>
<p>打开这个网站:<br>
<a target="_blank" rel="noopener" href="https://d.serctl.com/?dl_start">https://d.serctl.com/?dl_start</a></p>
<p>下载内核的压缩包<br>
<a target="_blank" rel="noopener" href="https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/zeus-s-oss.zip"> https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/zeus-s-oss.zip</a></p>
<p>下载 clang 编译器:<br>
<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/master">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/master</a><br>
 (魔法上网)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm64</span><br><span class="line">export SUBARCH=arm64</span><br><span class="line">export CROSS_COMPILE=/home/shocker/aosp12/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-</span><br></pre></td></tr></table></figure>
<p>CROSS_COMPILE 是我之前编译 aosp 的时候用的，源码里自带的.</p>
<p>编译命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make O=out CC=/home/shocker/clang/bin/clang CLANG_TRIPLE=aarch64-linux-android- generic_vm_defconfig</span><br><span class="line">make -j$(nproc) O=out CC=/home/shocker/clang/bin/clang  CLANG_TRIPLE=aarch64-linux-android- </span><br></pre></td></tr></table></figure>
<h2 id="踩坑记录"><a class="markdownIt-Anchor" href="#踩坑记录"></a> 踩坑记录</h2>
<p>重点来了，小米 12 的内核会缺很多文件，必须手动把每个错误都处理掉.</p>
<h3 id="错误一"><a class="markdownIt-Anchor" href="#错误一"></a> 错误一</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drivers/misc/Kconfig:540: can&#x27;t open file &quot;drivers/misc/hwid/Kconfig&quot;</span><br></pre></td></tr></table></figure>
<p>打开 drivers/misc/Kconfig 删掉 540 行的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;drivers/misc/hwid/Kconfig&quot;</span><br></pre></td></tr></table></figure>
<h3 id="错误二"><a class="markdownIt-Anchor" href="#错误二"></a> 错误二</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">../scripts/Makefile.build:44: ../drivers/misc/hwid/Makefile: No such file or directory</span><br><span class="line">make[4]: *** No rule to make target &#x27;../drivers/misc/hwid/Makefile&#x27;.  Stop.</span><br><span class="line">../scripts/Makefile.build:520: recipe for target &#x27;drivers/misc/hwid&#x27; failed</span><br><span class="line">make[3]: *** [drivers/misc/hwid] Error 2</span><br><span class="line">../scripts/Makefile.build:520: recipe for target &#x27;drivers/misc&#x27; failed</span><br><span class="line">make[2]: *** [drivers/misc] Error 2</span><br><span class="line">/home/shocker/kernel/Xiaomi_Kernel_OpenSource-zeus-s-oss/Makefile:1931: recipe for target &#x27;drivers&#x27; failed</span><br></pre></td></tr></table></figure>
<p>修改./drivers/misc/Makefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./drivers/misc/Makefile</span><br></pre></td></tr></table></figure>
<p>注释所有带 hwid 的行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ccflags-y += -I$(srctree)/drivers/misc/hwid/</span><br><span class="line">#obj-y                          += hwid/</span><br></pre></td></tr></table></figure>
<h3 id="错误三"><a class="markdownIt-Anchor" href="#错误三"></a> 错误三</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_interface.h:11:10: fatal error: &#x27;media/cam_req_mgr.h&#x27; file not found</span><br><span class="line">#include &lt;media/cam_req_mgr.h&gt;</span><br><span class="line">         ^~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">../scripts/Makefile.build:277: recipe for target &#x27;techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_core.o&#x27; failed</span><br><span class="line">make[3]: *** [techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_core.o] Error 1</span><br><span class="line">make[3]: *** Waiting for unfinished jobs....</span><br><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.c:13:10: fatal error: &#x27;mm/slab.h&#x27; file not found</span><br><span class="line">#include &lt;mm/slab.h&gt;</span><br><span class="line">         ^~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">../scripts/Makefile.build:277: recipe for target &#x27;techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.o&#x27; failed</span><br><span class="line">make[3]: *** [techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.o] Error 1</span><br><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_util.c:15:10: fatal error: &#x27;media/cam_req_mgr.h&#x27; file not found</span><br><span class="line">#include &lt;media/cam_req_mgr.h&gt;</span><br></pre></td></tr></table></figure>
<p>把./techpack/camera-kernel/ 删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -r techpack/camera-kernel/</span><br></pre></td></tr></table></figure>
<h3 id="错误四"><a class="markdownIt-Anchor" href="#错误四"></a> 错误四</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">../drivers/android/vendor_hooks.c:42:10: fatal error: &#x27;trace/hooks/thermal.h&#x27; file not found</span><br><span class="line">#include &lt;trace/hooks/thermal.h&gt;</span><br></pre></td></tr></table></figure>
<p>注释掉所有引用到 thermal.h 的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./drivers/android/vendor_hooks.c</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//#include &lt;trace/hooks/thermal.h&gt;</span><br><span class="line">//EXPORT_TRACEPOINT_SYMBOL_GPL(android_vh_enable_thermal_genl_check);</span><br><span class="line">//EXPORT_TRACEPOINT_SYMBOL_GPL(android_vh_thermal_pm_notify_suspend);</span><br></pre></td></tr></table></figure>
<p>然后就编译完成了<br>
<img src="https://pshocker.github.io/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/res.png" alt></p>
<h2 id="编译模块"><a class="markdownIt-Anchor" href="#编译模块"></a> 编译模块</h2>
<p>一个最简单的内核模块<br>
 hello.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static int hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_WARNING&quot;Hello world!\n&quot;);</span><br><span class="line">    return 0;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_WARNING&quot;hello exit!\n&quot;);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>
<p>Makefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hello.o</span><br><span class="line">KDIR := /home/shocker/Xiaomi_Kernel_OpenSource-zeus-s-oss/out</span><br><span class="line">CFLAGS_MODULE=-fno-pic</span><br><span class="line">ARCH=arm64</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	make -C $(KDIR) M=$(PWD) modules </span><br><span class="line">clean:    </span><br><span class="line">	rm -f *.ko *.o *.mod.o *.mod.c *.symvers *.order</span><br></pre></td></tr></table></figure>
<p>编译命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(nproc) CC=/home/shocker/clang/bin/clang  CLANG_TRIPLE=aarch64-linux-android-</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ko.png" alt></p>
<p>github 地址:<br>
<a target="_blank" rel="noopener" href="https://github.com/PShocker/hellokernel">https://github.com/PShocker/hellokernel</a></p>
<p>参考了泓清大佬的文章:<br>
<a target="_blank" rel="noopener" href="https://blog.hongqing.online/android/BuildAndroidKernel/">【Android Kernel】编译总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/" class="post-title-link" itemprop="url">Android外部imgui绘制--JNIRoot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-21 15:33:44" itemprop="dateCreated datePublished" datetime="2022-04-21T15:33:44+08:00">2022-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:34:17" itemprop="dateModified" datetime="2022-06-10T14:34:17+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前几天听说了个 jniroot, 貌似很厉害的样子<br>
<a target="_blank" rel="noopener" href="https://github.com/topjohnwu/libsu"> https://github.com/topjohnwu/libsu</a></p>
<p>想着能不能适配 imgui.<br>
 干就完事了.<br>
<img src="https://pshocker.github.io/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/gif.gif" alt></p>
<p><strong>改进后的 libsu 模板在这里</strong><br>
<strong><a target="_blank" rel="noopener" href="https://github.com/PShocker/libsutemplate"> https://github.com/PShocker/libsutemplate</a></strong></p>
<p>1. 新建 Native C++ 项目，把 libsu 的依赖全部加进去</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        <span class="comment">// This library uses Java 8 features, this is required</span></span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://jitpack.io&#x27;</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    def libsuVersion = <span class="string">&#x27;4.0.3&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The core module is used by all other components</span></span><br><span class="line">    implementation <span class="string">&quot;com.github.topjohnwu.libsu:core:$&#123;libsuVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optional: APIs for creating root services</span></span><br><span class="line">    implementation <span class="string">&quot;com.github.topjohnwu.libsu:service:$&#123;libsuVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optional: For com.topjohnwu.superuser.io classes</span></span><br><span class="line">    implementation <span class="string">&quot;com.github.topjohnwu.libsu:io:$&#123;libsuVersion&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Optional: Bundle prebuilt BusyBox binaries</span></span><br><span class="line">    implementation <span class="string">&quot;com.github.topjohnwu.libsu:busybox:$&#123;libsuVersion&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若报错，把 maven { url ‘<a target="_blank" rel="noopener" href="https://jitpack.io">https://jitpack.io</a>’ } 添加到 settings.gradle 里</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url &#x27;https://jitpack.io&#x27; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2. 新建 aidl 文件，Rebuild 生成 Stub 文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">IImGuiService</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Demonstrates some basic types that you can use as parameters</span></span><br><span class="line"><span class="comment">     * and return values in AIDL.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init_ImGui</span><span class="params">(inout Surface surface)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update_ImGui</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span>;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">set_ImGui_Orientation</span><span class="params">(<span class="type">int</span> orientation)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建 AIDLService 类，继承 RootService.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AIDLService</span> <span class="keyword">extends</span> <span class="title class_">RootService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// Only load the library when this class is loaded in a root process.</span></span><br><span class="line">        <span class="comment">// The classloader will load this class (and call this static block) in the non-root</span></span><br><span class="line">        <span class="comment">// process because we accessed it when constructing the Intent to send.</span></span><br><span class="line">        <span class="comment">// Add this check so we don&#x27;t unnecessarily load native code that&#x27;ll never be used.</span></span><br><span class="line">        <span class="keyword">if</span> (Process.myUid() == <span class="number">0</span>)</span><br><span class="line">            System.loadLibrary(<span class="string">&quot;imgui&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">native_init_ImGui</span><span class="params">(Surface surface)</span>; <span class="comment">//imgui初始化,读取输入,渲染.</span></span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">native_update_ImGui</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">native_set_ImGui_Orientation</span><span class="params">(<span class="type">int</span> orientation)</span>; <span class="comment">//设置屏幕方向</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ImGui</span> <span class="keyword">extends</span> <span class="title class_">IImGuiService</span>.Stub &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init_ImGui</span><span class="params">(Surface surface)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            native_init_ImGui(surface);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update_ImGui</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            native_update_ImGui(width,height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set_ImGui_Orientation</span><span class="params">(<span class="type">int</span> orientation)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            native_set_ImGui_Orientation(orientation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> IBinder <span class="title function_">onBind</span><span class="params">(<span class="meta">@NonNull</span> Intent intent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ImGui</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3. 新建 ImGuiView 类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ImGuiView</span> <span class="keyword">extends</span> <span class="title class_">SurfaceView</span> <span class="keyword">implements</span> <span class="title class_">SurfaceHolder</span>.Callback&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">ImGuiView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(context);</span><br><span class="line">      setZOrderOnTop(<span class="literal">true</span>);</span><br><span class="line">      <span class="type">SurfaceHolder</span> <span class="variable">holder</span> <span class="operator">=</span> getHolder();</span><br><span class="line">      holder.setFormat(PixelFormat.TRANSLUCENT);</span><br><span class="line">      getHolder().addCallback(<span class="built_in">this</span>);</span><br><span class="line">      setFocusable(<span class="literal">true</span>);</span><br><span class="line">      setFocusableInTouchMode(<span class="literal">true</span>);</span><br><span class="line">      requestFocus();</span><br><span class="line">      requestFocusFromTouch();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceCreated</span><span class="params">(<span class="meta">@NonNull</span> SurfaceHolder surfaceHolder)</span> &#123;</span><br><span class="line">      Log.d(<span class="string">&quot;Shocker&quot;</span>,<span class="string">&quot;surfaceCreated&quot;</span>); <span class="comment">//这里需要新线程在native里完成初始化,读取输入和渲染</span></span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                  MainActivity.ImGui.init_ImGui(surfaceHolder.getSurface());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;).start();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceChanged</span><span class="params">(<span class="meta">@NonNull</span> SurfaceHolder surfaceHolder, <span class="type">int</span> i, <span class="type">int</span> i1, <span class="type">int</span> i2)</span> &#123;</span><br><span class="line">       ....... <span class="comment">//处理屏幕旋转事件</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">surfaceDestroyed</span><span class="params">(<span class="meta">@NonNull</span> SurfaceHolder surfaceHolder)</span> &#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4. 新建 AIDLConnection 类，在 MainActivity 的 OnCreate 里绑定 RootService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IImGuiService ImGui;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AIDLConnection</span> <span class="keyword">implements</span> <span class="title class_">ServiceConnection</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> isDaemon;</span><br><span class="line"></span><br><span class="line">        AIDLConnection(<span class="type">boolean</span> b) &#123;</span><br><span class="line">            isDaemon = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> &#123;</span><br><span class="line">            ImGui= IImGuiService.Stub.asInterface(service);</span><br><span class="line">            Log.d(<span class="string">&quot;Shocker&quot;</span>,<span class="string">&quot;Connected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onServiceDisconnected</span><span class="params">(ComponentName componentName)</span> &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;Shocker&quot;</span>,<span class="string">&quot;Disconnected&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        ..............</span><br><span class="line">        RootService.bind(<span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, AIDLService.class), <span class="keyword">new</span> <span class="title class_">AIDLConnection</span>(<span class="literal">false</span>));</span><br><span class="line">        t.setOnClickListener(view -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (!start)&#123;</span><br><span class="line">                addFullView(); <span class="comment">//添加悬浮窗</span></span><br><span class="line">                start=<span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>5.native 完成 imgui 初始化，循环读取输入和渲染</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Java_com_shocker_imgui_AIDLService_native_1init_1ImGui</span>(JNIEnv *env, jobject thiz, jobject surface) &#123;</span><br><span class="line">    ANativeWindow* w = <span class="built_in">ANativeWindow_fromSurface</span>(env, (jobject)surface);</span><br><span class="line">    <span class="built_in">init</span>(w); <span class="comment">//初始化imgui</span></span><br><span class="line">    <span class="built_in">ANativeWindow_release</span>(w);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="built_in">handleInputEvent</span>();</span><br><span class="line">        <span class="built_in">tick</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/pic.jpg" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/17/Android%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87%E6%AF%94%E8%BE%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/17/Android%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87%E6%AF%94%E8%BE%83/" class="post-title-link" itemprop="url">Android读写内存效率比较</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-17 14:15:22" itemprop="dateCreated datePublished" datetime="2022-04-17T14:15:22+08:00">2022-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:34:42" itemprop="dateModified" datetime="2022-06-10T14:34:42+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>众所周知，安卓平台读写内存的方式有</p>
<p>1.read write /proc/xx/mem 文件<br>
 2.ptrace<br>
3.syscall<br>
4. 注入读写 (Magisk 注入)</p>
<p>那么他们谁的读写效率更高呢？</p>
<p>测试方法很简单。读写 100000 次，记录时间差</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;old);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">..............</span><br><span class="line">..............</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">clock_gettime</span>(CLOCK_MONOTONIC, &amp;now);</span><br><span class="line">cout &lt;&lt; <span class="string">&quot;time passed is: &quot;</span> &lt;&lt; (now.tv_sec - old.tv_sec) * <span class="number">1000</span> + (now.tv_nsec - old.tv_nsec) / <span class="number">1000000</span> &lt;&lt; <span class="string">&quot;ms&quot;</span> &lt;&lt; endl;</span><br></pre></td></tr></table></figure>
<p>以下是分别测试读写 100000 次所需要的时间</p>
<table border="0" cellpadding="0" cellspacing="0" width="646" style="border-collapse:
 collapse;table-layout:fixed;width:485pt">
 <col width="64" style="width:48pt">
 <col width="146" style="mso-width-source:userset;mso-width-alt:5176;width:109pt">
 <col width="156" style="mso-width-source:userset;mso-width-alt:5546;width:117pt">
 <col width="150" style="mso-width-source:userset;mso-width-alt:5347;width:113pt">
 <col width="130" style="mso-width-source:userset;mso-width-alt:4636;width:98pt">
 <tr height="18" style="height:13.8pt">
  <td height="18" width="64" style="height:13.8pt;width:48pt"></td>
  <td width="146" style="width:109pt">mem</td>
  <td width="156" style="width:117pt">ptrace</td>
  <td width="150" style="width:113pt">syscall</td>
  <td width="130" style="width:98pt">注入读写</td>
 </tr>
 <tr height="18" style="height:13.8pt">
  <td height="18" style="height:13.8pt">读</td>
  <td>155ms</td>
  <td>2983ms</td>
  <td>101ms</td>
  <td>0.000069ms</td>
 </tr>
 <tr height="18" style="height:13.8pt">
  <td height="18" style="height:13.8pt">写</td>
  <td>416ms</td>
  <td>2940ms</td>
  <td>88ms</td>
  <td>0.000243ms</td>
 </tr>
</table>
<p>可以看出，效率最快的是注入读写，比 syscall 和读 mem 快了近 1000000 倍.</p>
<p>而 ptrace 效率低很大程度上因为 ptrace 的 PTRACE_ATTACH 和 PTRACE_DETACH 消耗了大量时间.</p>
<p>读写效率:<br>
 注入读写 &gt;&gt; syscall &gt; mem &gt; ptrace</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/" class="post-title-link" itemprop="url">Hook surfaceflinger进程给surface开后门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-16 14:21:03" itemprop="dateCreated datePublished" datetime="2022-04-16T14:21:03+08:00">2022-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:21:13" itemprop="dateModified" datetime="2022-06-10T14:21:13+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>对于可执行文件创建的 surface 来说。它的 uid 和 pid 都为 0.</p>
<p>对于 app 内部创建的 surface 来说。它的 uid 和 pid 都不为 0.</p>
<p>见<a href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/"> Magisk 注入 app 并嵌入 imgui (三)</a></p>
<p>我们只需要找到 app 创建的 surface, 并把它的 pid 和 uid 改成 0, 就可以实现可执行文件的效果.</p>
<p>1. 注入 surfaceflinger 进程<br>
参考:<a target="_blank" rel="noopener" href="https://github.com/PShocker/AndroidPtraceInject">AndroidPtraceInject</a><br>
 参考:<a target="_blank" rel="noopener" href="https://github.com/SsageParuders/AndroidPtraceInject">AndroidPtraceInject</a></p>
<p>2.Dobby hook createSurface</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">hook_createSurface</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;hook_createSurface start\n&quot;</span>);</span><br><span class="line">    <span class="type">void</span> *sym = <span class="built_in">DobbySymbolResolver</span>(<span class="literal">NULL</span>, <span class="string">&quot;_ZN7android6Client13createSurfaceERKNS_7String8EjjijRKNS_2spINS_7IBinderEEENS_13LayerMetadataEPS6_PNS4_INS_22IGraphicBufferProducerEEEPiPj&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != sym)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;_ZN7android6Client13createSurfaceERKNS_7String8EjjijRKNS_2spINS_7IBinderEEENS_13LayerMetadataEPS6_PNS4_INS_22IGraphicBufferProducerEEEPiPj:%llx&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)sym);</span><br><span class="line">        <span class="built_in">DobbyHook</span>(sym, (<span class="type">void</span> *)new_createSurface, (<span class="type">void</span> **)&amp;ori_createSurface);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;hook_createSurface finish\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3. 从 surface 的 name 拿到想要 hook 的 surface 的 pid 和 uid</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">new_createSurface</span><span class="params">(<span class="type">void</span> *thiz, <span class="type">void</span> *a2, <span class="type">void</span> *a3, <span class="type">void</span> *a4, <span class="type">void</span> *a5, <span class="type">void</span> *a6, <span class="type">void</span> *a7, <span class="type">void</span> *a8, <span class="type">void</span> *a9, <span class="type">void</span> *a10, <span class="type">void</span> *a11, <span class="type">void</span> *a12)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LOGD(&quot;new_createSurface&quot;);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ori_createSurface)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to get original new_createSurface&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;str:%llx&quot;</span>, *(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)a2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)*(<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> *)a2 == <span class="number">0x72656b636f6853</span>) <span class="comment">//这里根据surface的名字来判断是否是要Hook的surface.strcmp()会闪退,只能用字符串的16进制来比较.</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;getCallingPid:%d&quot;</span>, <span class="built_in">getCallingPid</span>());</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;getCallingUid:%d&quot;</span>, <span class="built_in">getCallingUid</span>());</span><br><span class="line">        Hook_Pid = <span class="built_in">getCallingPid</span>(); <span class="comment">//这里拿到Pid</span></span><br><span class="line">        Hook_Uid = <span class="built_in">getCallingUid</span>(); <span class="comment">//Uid</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ori_createSurface</span>(thiz, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.Dobby hook getCallingPid 和 getCallingUid<br>
Hook 代码省略</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">new_getCallingPid</span><span class="params">(<span class="type">void</span> *thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LOGD(&quot;new_getCallingPid&quot;);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ori_getCallingPid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to get original new_getCallingPid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> Pid = <span class="built_in">ori_getCallingPid</span>(thiz);</span><br><span class="line">    <span class="keyword">if</span> (Pid == Hook_Pid)</span><br><span class="line">    &#123;</span><br><span class="line">        Hook_Uid = <span class="built_in">getCallingUid</span>(); <span class="comment">//更新Uid</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">//如果是我们创建的surface,就返回0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Pid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">int64_t</span> <span class="title">new_getCallingUid</span><span class="params">(<span class="type">void</span> *thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LOGD(&quot;new_getCallingUid&quot;);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ori_getCallingUid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;failed to get original new_getCallingUid&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> Uid = <span class="built_in">ori_getCallingUid</span>(thiz);</span><br><span class="line">    <span class="keyword">if</span> (Uid == Hook_Uid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// LOGE(&quot;Hook Uid&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 如果是我们创建的surface,就返回0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Uid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getCallingPid () 和 getCallingUid () 可以在 aosp 环境里封装一个.a 的静态库<br>
编译的时候链接就行.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCallingPid</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IPCThreadState *ipc = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line">    <span class="keyword">return</span> ipc-&gt;<span class="built_in">getCallingPid</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">getCallingUid</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IPCThreadState *ipc = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line">    <span class="keyword">return</span> ipc-&gt;<span class="built_in">getCallingUid</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/" class="post-title-link" itemprop="url">Magisk注入app并嵌入imgui(三)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-16 11:26:19" itemprop="dateCreated datePublished" datetime="2022-04-16T11:26:19+08:00">2022-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:21:06" itemprop="dateModified" datetime="2022-06-10T14:21:06+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在<a href="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/"> Magisk 注入 app 并嵌入 imgui (二)</a> 里成功创建了 surface, 但是 imgui 的画面并没有显示出来，<br>
<img src="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/why.jpg" alt></p>
<p>看看 SurfaceFlinger 的信息.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys SurfaceFlinger</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/layers.png" alt></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Offscreen Layers:</span><br><span class="line">Layer Surface(name=cac9055 InputMethod)/@0x5406b5b - animation-leash of insets_animation#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=50f3462 com.tencent.mf.uam/com.epicgames.ue4.GameActivity)/@0x5e8236 - animation-leash of starting_reveal#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=Task=1)/@0xca72fe0 - animation-leash of app_transition#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=Task=185)/@0xc4029e3 - animation-leash of app_transition#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Shocker#0 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br><span class="line">Layer bbq-wrapper#1 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br></pre></td></tr></table></figure>
<p>唉，我的 Layer 怎么在 Offscreen 里？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Layer Shocker#0 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br></pre></td></tr></table></figure>
<p>打开 imgui 可执行文件的版本.<br>
 看看有什么区别.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+ BufferStateLayer (ImGuiLink#0  screenFlags = 0  miuiVkWidgetTransparent = 0) uid=0</span><br><span class="line">  Region TransparentRegion (this=0 count=0)</span><br><span class="line">  Region VisibleRegion (this=0 count=0)</span><br><span class="line">  Region SurfaceDamageRegion (this=0 count=0)</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  -1,  -1), crop=[  0,   0,  -1,  -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=0, dataspace=Default, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000000, tr=[0.00, 0.00][0.00, 0.00]</span><br><span class="line">      parent=none</span><br><span class="line">      zOrderRelativeOf=none</span><br><span class="line">      activeBuffer=[   0x   0:   0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata=&#123;&#125;, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00],  shadowRadius=0.000,</span><br><span class="line">+ BufferStateLayer (bbq-wrapper#0  screenFlags = 0  miuiVkWidgetTransparent = 0) uid=0</span><br><span class="line">  Region TransparentRegion (this=0 count=0)</span><br><span class="line">  Region VisibleRegion (this=0 count=1)</span><br><span class="line">    [  0,   0, 1440, 3200]</span><br><span class="line">  Region SurfaceDamageRegion (this=0 count=0)</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(1440,3200), crop=[  0,   0,  -1,  -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=0, dataspace=Default, defaultPixelFormat=RGBA_8888, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000100, tr=[0.00, 0.00][0.00, 0.00]</span><br><span class="line">      parent=ImGuiLink#0  screenFlags = 0  miuiVkWidgetTransparent = 0</span><br><span class="line">      zOrderRelativeOf=none</span><br><span class="line">      activeBuffer=[1440x3200:1472,RGBA_8888], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata=&#123;dequeueTime:514178138135&#125;, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00],  shadowRadius=0.000,</span><br></pre></td></tr></table></figure>
<p>唉，发现可执行文件的 uid=0 而，app 创建的 surface 的 uid 不为 0.</p>
<p>去源码看看.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4353</span>      <span class="type">bool</span> addToRoot = <span class="built_in">callingThreadHasUnscopedSurfaceFlingerAccess</span>();</span><br><span class="line"><span class="number">4354</span>      result = <span class="built_in">addClientLayer</span>(client, *handle, *gbp, layer, parentHandle, parentLayer, addToRoot,</span><br><span class="line"><span class="number">4355</span>                              outTransformHint);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/s?refs=createLayer&amp;project=frameworks">http://aospxref.com/android-12.0.0_r3/s?refs=createLayer&amp;project=frameworks</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3888</span>  <span class="function"><span class="type">bool</span> <span class="title">SurfaceFlinger::callingThreadHasUnscopedSurfaceFlingerAccess</span><span class="params">(<span class="type">bool</span> usePermissionCache)</span> </span>&#123;</span><br><span class="line"><span class="number">3889</span>      IPCThreadState* ipc = IPCThreadState::<span class="built_in">self</span>();</span><br><span class="line"><span class="number">3890</span>      <span class="type">const</span> <span class="type">int</span> pid = ipc-&gt;<span class="built_in">getCallingPid</span>();</span><br><span class="line"><span class="number">3891</span>      <span class="type">const</span> <span class="type">int</span> uid = ipc-&gt;<span class="built_in">getCallingUid</span>();</span><br><span class="line"><span class="number">3892</span>      <span class="keyword">if</span> ((uid != AID_GRAPHICS &amp;&amp; uid != AID_SYSTEM) &amp;&amp;</span><br><span class="line"><span class="number">3893</span>          (usePermissionCache ? !PermissionCache::<span class="built_in">checkPermission</span>(sAccessSurfaceFlinger, pid, uid)</span><br><span class="line"><span class="number">3894</span>                              : !<span class="built_in">checkPermission</span>(sAccessSurfaceFlinger, pid, uid))) &#123;</span><br><span class="line"><span class="number">3895</span>          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="number">3896</span>      &#125;</span><br><span class="line"><span class="number">3897</span>      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="number">3898</span>  &#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/s?refs=callingThreadHasUnscopedSurfaceFlingerAccess&amp;project=frameworks">http://aospxref.com/android-12.0.0_r3/s?refs=callingThreadHasUnscopedSurfaceFlingerAccess&amp;project=frameworks</a></p>
<p>这里的 pid,uid 就是通过下面的函数获取的.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3890</span>      <span class="type">const</span> <span class="type">int</span> pid = ipc-&gt;<span class="built_in">getCallingPid</span>();</span><br><span class="line"><span class="number">3891</span>      <span class="type">const</span> <span class="type">int</span> uid = ipc-&gt;<span class="built_in">getCallingUid</span>();</span><br></pre></td></tr></table></figure>
<p>对于可执行文件来说，pid 和 uid 都是 0.</p>
<p>那么有没有办法让我们创建的 surface pid 和 uid 同时为 0 呢？</p>
<p>当然有…<br>
<a href="https://pshocker.github.io/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/">Hook surfaceflinger 进程给 surface 开后门</a></p>
<p>最后做一个总结:<br>
 相比于外部 imgui,hook eglswapbuffers 来说，creteSurface 基本上是最优解，它既不会涉及到跨进程读写内存，也不会卡游戏画面.<br>
 唯一美中不足的地方就是编译复杂，没法跨安卓版本使用.</p>
<p><img src="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/dog.gif" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/" class="post-title-link" itemprop="url">Magisk注入app并嵌入imgui(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-15 22:49:47" itemprop="dateCreated datePublished" datetime="2022-04-15T22:49:47+08:00">2022-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:21:12" itemprop="dateModified" datetime="2022-06-10T14:21:12+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前我写过一篇文章介绍了<a href="https://pshocker.github.io/2022/03/21/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui/"> Magisk 注入 app 并嵌入 imgui</a>.<br>
 其原理就是 Hook app 进程的 eglSwapBuffers 函数。在其中完成 imgui 的初始化的显示.</p>
<p>但我测试 UE4 游戏的时候发现，要么画面出不来，要么就闪退.<br>
 大概率是和引擎冲突了…<br>
 淦.<br>
<img src="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/g.jpg" alt></p>
<p>没办法，那么就创建一个 surface.<br>
 注意，createSurface 等函数需要 aosp 环境。所以需要在<strong> aosp 环境里编译 zygisk 模块.</strong></p>
<h2 id="环境和工具"><a class="markdownIt-Anchor" href="#环境和工具"></a> 环境和工具</h2>
<p>1.Android 12 环境 (版本可根据自己真机版本选择，硬盘空间最好大于 250G, 不然拉取失败会出现很多问题)<br>
 2.wsl 或虚拟机 (wsl Ubuntu18.04)<br>
 3. 安卓真机 (小米 12)</p>
<h2 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h2>
<h3 id="下载android12编译android12"><a class="markdownIt-Anchor" href="#下载android12编译android12"></a> 下载 Android12, 编译 Android12.</h3>
<p>这些网上有很多教学，值得一提的是，相比 Android5, 新版本编译的时候没有什么错误，基本上一次过。很爽.</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/grackergao/article/details/120984766">Android 系统开发系列（1）：Android 12 源代码下载、编译和刷机</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68918808">死磕 Android_AOSP 编译过程</a></p>
<p><strong>注意：硬盘剩余空间一定要大于 250g, 硬盘剩余空间一定要大于 250g, 硬盘剩余空间一定要大于 250g</strong><br>
<strong> 否则失败了会很麻烦.</strong></p>
<p><img src="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/kk.jpg" alt></p>
<h3 id="复制源文件到android源码里"><a class="markdownIt-Anchor" href="#复制源文件到android源码里"></a> 复制源文件到 Android 源码里</h3>
<p>参考<a href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/"> Android 可执行文件 imgui 绘制</a>，区别就是编译成动态库 (cc_library_shared), 还要把 zygisk 头文件丢进去.<br>
<img src="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/vscode.jpg" alt><br>
 文件结构如上图.</p>
<h3 id="过滤到包名多线程创建imgui"><a class="markdownIt-Anchor" href="#过滤到包名多线程创建imgui"></a> 过滤到包名，多线程创建 imgui</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">postAppSpecialize</span><span class="params">(<span class="type">const</span> AppSpecializeArgs *args)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Use JNI to fetch our process name</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *process = env-&gt;<span class="built_in">GetStringUTFChars</span>(args-&gt;nice_name, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">init</span>(process) == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//没有找到游戏</span></span><br><span class="line">        api-&gt;<span class="built_in">setOption</span>(zygisk::Option::DLCLOSE_MODULE_LIBRARY);</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;<span class="built_in">ReleaseStringUTFChars</span>(args-&gt;nice_name, process);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">init</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *process)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LOGD(&quot;example: process=[%s]&quot;, process);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(hook_pkg_name, process) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">pthread_t</span> ntid;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">pthread_create</span>(&amp;ntid, <span class="literal">nullptr</span>, startImGui, <span class="literal">nullptr</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">LOGD</span>(<span class="string">&quot;can&#x27;t create thread&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里 startImGui 的代码和<a href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/"> Android 可执行文件 imgui 绘制</a>代码一致.</p>
<h3 id="观察结果"><a class="markdownIt-Anchor" href="#观察结果"></a> 观察结果</h3>
<p>然后你会发现完全没有效果，但这并不意味着创建 surface 失败了，因为如果你打印 surface 的地址，会发现是有值的，如果你在 tick 打印日志，会发现日志会一直有输出.<br>
<img src="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/log.jpg" alt><br>
 为啥会这样呢？</p>
<p>见<a href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/"> Magisk 注入 app 并嵌入 imgui (三)</a>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/" class="post-title-link" itemprop="url">Android可执行文件imgui绘制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-15 21:49:47" itemprop="dateCreated datePublished" datetime="2022-04-15T21:49:47+08:00">2022-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:20:55" itemprop="dateModified" datetime="2022-06-10T14:20:55+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前我在<a href="https://pshocker.github.io/2022/03/23/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C/"> Android 外部 imgui 绘制 (二)</a> 里说过</p>
<p><strong>在 Android 外部 imgui 绘制 (一) 里介绍了怎么实现一个外部 imgui, 其实还有一种方法，就是在 aosp 环境下编译一个可执行文件出来，有点类似于</strong><br>
<strong>可执行文件 + skia 绘制</strong><br>
<strong>但这个其实很麻烦，需要下载 android 源码 (100 多 g), 然后还要自己编译，最后还得修改代码。所以不太建议这么做。虽然效率可能确实会有提升.</strong></p>
<p>好吧，我来填坑了.</p>
<h2 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h2>
<h3 id="下载android12编译android12"><a class="markdownIt-Anchor" href="#下载android12编译android12"></a> 下载 Android12, 编译 Android12.</h3>
<p>这些网上有很多教学，值得一提的是，相比 Android5, 新版本编译的时候没有什么错误，基本上一次过。很爽.</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/grackergao/article/details/120984766">Android 系统开发系列（1）：Android 12 源代码下载、编译和刷机</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68918808">死磕 Android_AOSP 编译过程</a></p>
<p><strong>注意：硬盘剩余空间一定要大于 250g, 硬盘剩余空间一定要大于 250g, 硬盘剩余空间一定要大于 250g</strong><br>
<strong> 否则失败了会很麻烦.</strong></p>
<h3 id="复制源文件到android源码里"><a class="markdownIt-Anchor" href="#复制源文件到android源码里"></a> 复制源文件到 Android 源码里</h3>
<p>把 imgui 的相关代码丢到 external 里.</p>
<p><img src="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/vscode.jpg" alt><br>
文件结构如上图.</p>
<h3 id="imgui"><a class="markdownIt-Anchor" href="#imgui"></a> imgui</h3>
<p>1. 新建 SurfaceComposerClient, 并从 SurfaceComposerClient 中创建 surface, 这个 SurfaceComposerClient 其实是 surfaceflinger 进程的代理对象.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceComposerClient&gt; client = <span class="keyword">new</span> <span class="built_in">SurfaceComposerClient</span>();</span><br><span class="line">sp&lt;IBinder&gt; mDisplay = SurfaceComposerClient::<span class="built_in">getInternalDisplayToken</span>();</span><br><span class="line"></span><br><span class="line">ui::DisplayMode mode;</span><br><span class="line"><span class="type">status_t</span> result = SurfaceComposerClient::<span class="built_in">getActiveDisplayMode</span>(mDisplay, &amp;mode);</span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; control = client-&gt;<span class="built_in">createSurface</span>(</span><br><span class="line">        <span class="built_in">String8</span>(<span class="string">&quot;Shocker&quot;</span>),</span><br><span class="line">        mode.resolution.<span class="built_in">getWidth</span>(),</span><br><span class="line">        mode.resolution.<span class="built_in">getHeight</span>(),</span><br><span class="line">        PIXEL_FORMAT_RGBA_8888,</span><br><span class="line">        ISurfaceComposerClient::eFXSurfaceBufferState,</span><br><span class="line">        <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>
<p>这其实非常重要，对于 imgui 来说，它只需要绑定一个窗口 (NativeWindow), 就可以在上面绘制.</p>
<p>2. 获取 NativeWindow, 绑定到 imgui 上</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; mSurface = control-&gt;<span class="built_in">getSurface</span>();</span><br><span class="line">sp&lt;ANativeWindow&gt; mANW = mSurface;</span><br><span class="line"><span class="function">ANativeWindow *<span class="title">g_EglNativeWindowType</span><span class="params">(mANW.get())</span></span>;</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;initSurface finish&quot;</span>);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;g_EglNativeWindowType:%llx&quot;</span>, g_EglNativeWindowType);</span><br><span class="line"></span><br><span class="line"><span class="built_in">init</span>(g_EglNativeWindowType);</span><br></pre></td></tr></table></figure>
<p>3.imgui 初始化</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(ANativeWindow *g_EglNativeWindowType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (g_Initialized)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">ANativeWindow_acquire</span>(g_EglNativeWindowType);</span><br><span class="line">............................</span><br><span class="line">(把源码里的g_App-&gt;window全部替换成g_EglNativeWindowType,其余不变)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.imgui 循环渲染</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">handleInputEvent</span>(); <span class="comment">//处理触摸事件,获取触摸可以参考我之前的文章.</span></span><br><span class="line">    <span class="built_in">tick</span>(); <span class="comment">//渲染画面</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="最后一点"><a class="markdownIt-Anchor" href="#最后一点"></a> 最后一点</h2>
<p>安卓 12 要用 Android.bp 文件来编写编译文件，貌似之前的 Android.mk 可以用，但有 bug.<br>
 附上我编译 imgui 用的 Android.bp 文件.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: &quot;ImGuiTest&quot;,</span><br><span class="line">    srcs: [&quot;src/**/*.cpp&quot;],</span><br><span class="line"></span><br><span class="line">    local_include_dirs: [</span><br><span class="line">        &quot;src&quot;,</span><br><span class="line">        &quot;src/imgui&quot;,</span><br><span class="line">        &quot;src/backends&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    cppflags: [</span><br><span class="line">        &quot;-Wno-error&quot;,</span><br><span class="line">        &quot;-Wno-sign-conversion&quot;,</span><br><span class="line">        &quot;-Wno-unused-parameter&quot;,</span><br><span class="line">        &quot;-Wno-sign-conversion&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    shared_libs: [</span><br><span class="line">        &quot;liblog&quot;,</span><br><span class="line">        &quot;libandroid&quot;,</span><br><span class="line">        &quot;libgui&quot;,</span><br><span class="line">        &quot;libEGL&quot;,</span><br><span class="line">        &quot;libGLESv2&quot;,</span><br><span class="line">        &quot;libbinder&quot;,</span><br><span class="line">        &quot;libui&quot;,</span><br><span class="line">        &quot;libutils&quot;,</span><br><span class="line">        &quot;libinput&quot;,</span><br><span class="line">        &quot;libinputflinger&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/imgui.jpg" alt></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/" class="post-title-link" itemprop="url">Magisk注入Unity全自动Hook实战--神庙逃亡2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-04 21:20:28" itemprop="dateCreated datePublished" datetime="2022-04-04T21:20:28+08:00">2022-04-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-17 16:45:15" itemprop="dateModified" datetime="2022-06-17T16:45:15+08:00">2022-06-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在之前的一篇文章<a href="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/"> Android 外部 imgui 绘制 (二)–补充<br>
</a>提到了<a target="_blank" rel="noopener" href="https://0x.mk/?p=192"> Unity 全自动 hook 的实现</a>。那么就来实战一下.<br>
 游戏:<a target="_blank" rel="noopener" href="https://tp2.uu.cc/"> 神庙逃亡 2</a></p>
<h2 id="工具"><a class="markdownIt-Anchor" href="#工具"></a> 工具</h2>
<p>1.<a target="_blank" rel="noopener" href="https://github.com/Perfare/Il2CppDumper">Il2CppDumper</a><br>
2.ida7.5<br>
3.ndk 等编译环境</p>
<h2 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h2>
<h3 id="il2cppdumper解压出dumpcs等函数信息"><a class="markdownIt-Anchor" href="#il2cppdumper解压出dumpcs等函数信息"></a> Il2CppDumper 解压出 dump.cs 等函数信息</h3>
<p>下载<a target="_blank" rel="noopener" href="https://github.com/Perfare/Il2CppDumper/releases/"> Il2CppDumper</a><br>
 把 apk 里的 global-metadata.dat, 和 libil2cpp.so 提取出来.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\assets\bin\Data\Managed\Metadata\global-metadata.dat</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\lib\armeabi-v7a\libil2cpp.so</span><br></pre></td></tr></table></figure>
<p>新建文件夹 out, 命令行执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Il2CppDumper.exe libil2cpp.so global-metadata.dat out</span><br></pre></td></tr></table></figure>
<p>之后解压后的头文件会在 out 文件夹里.<br>
<img src="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/out.png" alt="out"></p>
<h3 id="dumpcs里搜索关键点"><a class="markdownIt-Anchor" href="#dumpcs里搜索关键点"></a> dump.cs 里搜索关键点</h3>
<p>打开 dump.cs, 搜索 kill. 顺便一提，对于没有加密的 u3 的游戏来说，关键点基本上就是 money,coin,kill,death,start 等。我的目标是实现人物无敌，所以才选择 kill.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// RVA: 0x7A7FE0 Offset: 0x7A7FE0 VA: 0x7A7FE0</span><br><span class="line">public void Kill(DeathTypes deathType, float shakeCamMagnitude = 0, bool killBySelf = False) &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>得到它的 RVA 是<strong> 0x7A7FE0</strong>.</p>
<h3 id="ida分析"><a class="markdownIt-Anchor" href="#ida分析"></a> ida 分析</h3>
<p>ida 打开  <code>libil2cpp.so</code> <br>
Alt+F7 执行脚本 ida_py3.py (这个脚本在 Il2CppDumper 里), 选择 out 文件夹里的 script.json, 导入所有函数符号到 ida.<br>
 跳转到地址 0x7A7FE0, 在函数头按 X 查看其交叉引用.<br>
<img src="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/ida0.png" alt="ida0"><br>
<img src="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/jcyy.png" alt="jcyy"><br>
 点击，因为 Stumble 有绊倒的意思。分析它大概是一个判断人物失误的函数.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRRunnerPawn$$Stumble+1548</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/ida.png" alt="ida"><br>
 唉，看到 Invincible 了，英语不好的我查了下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invincible 无敌的; 不可战胜的; 不能改变的;</span><br></pre></td></tr></table></figure>
<p>好家伙，这不就是我们要的判断无敌的函数吗？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRRunnerPawn__IsInvincible(a1)</span><br></pre></td></tr></table></figure>
<p>干就完事了.</p>
<h3 id="自动hook"><a class="markdownIt-Anchor" href="#自动hook"></a> 自动 Hook</h3>
<p>dump.cs 搜索 IsInvincible</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// RVA: 0x795050 Offset: 0x795050 VA: 0x795050</span><br><span class="line">public bool IsInvincible() &#123; &#125;</span><br></pre></td></tr></table></figure>
<p>拿到地址后可以去 ida 修改硬编码，直接返回 true. 但是这样不够自动化。万一版本更新偏移变了咋办？</p>
<p>还记得一开头的<a target="_blank" rel="noopener" href="https://0x.mk/?p=192"> Unity 全自动 hook 的实现</a>吗？<br>
<a target="_blank" rel="noopener" href="https://github.com/kotori2/riru_unity_example">https://github.com/kotori2/riru_unity_example</a>.</p>
<p>我们就来全自动 hook 一次.-_-</p>
<p>大佬已经帮我们写好框架了。只需要填就行.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Il2CppClass* clazz = <span class="built_in">il2cpp_class_from_name</span>(image, <span class="string">&quot;&quot;</span>, <span class="string">&quot;TRRunnerPawn&quot;</span>);</span><br><span class="line"><span class="built_in">hook_each</span>((<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">il2cpp_class_get_method_from_name</span>(clazz, <span class="string">&quot;IsInvincible&quot;</span>, <span class="number">0</span>)-&gt;methodPointer, (<span class="type">void</span> *)hook_invincible, (<span class="type">void</span> **)&amp;backup_invincible);</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">hook_invincible</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (backup_invincible == <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGE</span>(<span class="string">&quot;backup DOES NOT EXIST&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// LOGD(&quot;hook&quot;);</span></span><br><span class="line">    <span class="type">int</span> r = <span class="built_in">backup_invincible</span>(a1);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意<br>
<strong> il2cpp_class_get_method_from_name 的第 3 个参数是该方法的参数个数 (dump.cs 里看到的参数个数，不是 ida), 填错就直接闪退.</strong></p>
<p><img src="https://pshocker.github.io/2022/04/04/Magisk%E6%B3%A8%E5%85%A5Unity%E5%85%A8%E8%87%AA%E5%8A%A8Hook%E5%AE%9E%E6%88%98-%E7%A5%9E%E5%BA%99%E9%80%83%E4%BA%A12/smtw.gif" alt="smtw"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/02/Android-Hook-native%E5%B1%82%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/02/Android-Hook-native%E5%B1%82%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%85%A5/" class="post-title-link" itemprop="url">Android Hook native层获取系统输入</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-02 21:51:03" itemprop="dateCreated datePublished" datetime="2022-04-02T21:51:03+08:00">2022-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:21:15" itemprop="dateModified" datetime="2022-06-10T14:21:15+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上一篇文章<a href="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/"> Android 外部 imgui 绘制 (二)–补充</a>补充说明了 ue4 游戏下触摸输入的获取方法。本篇介绍一种更为通用的获取系统输入的方法.</p>
<h2 id="原理"><a class="markdownIt-Anchor" href="#原理"></a> 原理</h2>
<p>在 Android 系统中获取系统输入的原理是读取 &quot;/dev/input/event&quot; 下的文件，监听是否有系统输入。然后将不同的输入进行加工，然后分发.<br>
 在安卓系统中输入事件被分成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KeyEvent(键盘输入)</span><br><span class="line">MotionEvent(触摸输入)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>参考<br>
<a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/native/libs/input/Input.cpp"> /frameworks/native/libs/input/Input.cpp</a></p>
<p>每一种 Event 在分发之前都会经过初始化的流程，以触摸事件为例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1345</span>  <span class="function"><span class="type">void</span> <span class="title">InputConsumer::initializeMotionEvent</span><span class="params">(MotionEvent* event, <span class="type">const</span> InputMessage* msg)</span> </span>&#123;</span><br><span class="line"><span class="number">1346</span>      <span class="type">uint32_t</span> pointerCount = msg-&gt;body.motion.pointerCount;</span><br><span class="line"><span class="number">1347</span>      PointerProperties pointerProperties[pointerCount];</span><br><span class="line"><span class="number">1348</span>      PointerCoords pointerCoords[pointerCount];</span><br><span class="line"><span class="number">1349</span>      <span class="keyword">for</span> (<span class="type">uint32_t</span> i = <span class="number">0</span>; i &lt; pointerCount; i++) &#123;</span><br><span class="line"><span class="number">1350</span>          pointerProperties[i].<span class="built_in">copyFrom</span>(msg-&gt;body.motion.pointers[i].properties);</span><br><span class="line"><span class="number">1351</span>          pointerCoords[i].<span class="built_in">copyFrom</span>(msg-&gt;body.motion.pointers[i].coords);</span><br><span class="line"><span class="number">1352</span>      &#125;</span><br><span class="line"><span class="number">1353</span>  </span><br><span class="line"><span class="number">1354</span>      ui::Transform transform;</span><br><span class="line"><span class="number">1355</span>      transform.<span class="built_in">set</span>(&#123;msg-&gt;body.motion.dsdx, msg-&gt;body.motion.dtdx, msg-&gt;body.motion.tx,</span><br><span class="line"><span class="number">1356</span>                     msg-&gt;body.motion.dtdy, msg-&gt;body.motion.dsdy, msg-&gt;body.motion.ty, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;);</span><br><span class="line"><span class="number">1357</span>      event-&gt;<span class="built_in">initialize</span>(msg-&gt;body.motion.eventId, msg-&gt;body.motion.deviceId, msg-&gt;body.motion.source,</span><br><span class="line"><span class="number">1358</span>                        msg-&gt;body.motion.displayId, msg-&gt;body.motion.hmac, msg-&gt;body.motion.action,</span><br><span class="line"><span class="number">1359</span>                        msg-&gt;body.motion.actionButton, msg-&gt;body.motion.flags,</span><br><span class="line"><span class="number">1360</span>                        msg-&gt;body.motion.edgeFlags, msg-&gt;body.motion.metaState,</span><br><span class="line"><span class="number">1361</span>                        msg-&gt;body.motion.buttonState, msg-&gt;body.motion.classification, transform,</span><br><span class="line"><span class="number">1362</span>                        msg-&gt;body.motion.xPrecision, msg-&gt;body.motion.yPrecision,</span><br><span class="line"><span class="number">1363</span>                        msg-&gt;body.motion.xCursorPosition, msg-&gt;body.motion.yCursorPosition,</span><br><span class="line"><span class="number">1364</span>                        msg-&gt;body.motion.displayWidth, msg-&gt;body.motion.displayHeight,</span><br><span class="line"><span class="number">1365</span>                        msg-&gt;body.motion.downTime, msg-&gt;body.motion.eventTime, pointerCount,</span><br><span class="line"><span class="number">1366</span>                        pointerProperties, pointerCoords);</span><br><span class="line"><span class="number">1367</span>  &#125;</span><br></pre></td></tr></table></figure>
<p>注意到，event-&gt;initialize 就是初始化一个 MotionEvent.<br>
<strong> 而这个函数 (InputConsumer::initializeMotionEvent) 就是需要 Hook 的函数.</strong><br>
 参考<br>
<a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/native/libs/input/InputTransport.cpp#initializeMotionEvent"> /frameworks/native/libs/input/InputTransport.cpp</a></p>
<h2 id="过程"><a class="markdownIt-Anchor" href="#过程"></a> 过程</h2>
<p>随便观察一个 app 进程的 maps, 过滤得到 libinput.so 的路径.</p>
<p><img src="https://pshocker.github.io/2022/04/02/Android-Hook-native%E5%B1%82%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%85%A5/libinput.png" alt="libinput"></p>
<p>这个 libinput.so 就包含上面 InputConsumer::initializeMotionEvent 的代码.</p>
<p>拉到电脑上，ida 打开.</p>
<p><img src="https://pshocker.github.io/2022/04/02/Android-Hook-native%E5%B1%82%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%85%A5/ida.png" alt="ida"><br>
 得到它的导出函数符号是</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_ZN7android13InputConsumer21initializeMotionEventEPNS_11MotionEventEPKNS_12InputMessageE</span><br></pre></td></tr></table></figure>
<p>用 Dobby 进行 hook</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">hook_input</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">void</span> *sym_input = <span class="built_in">DobbySymbolResolver</span>(<span class="literal">NULL</span>, <span class="string">&quot;_ZN7android13InputConsumer21initializeMotionEventEPNS_11MotionEventEPKNS_12InputMessageE&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> != sym_input)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;_ZN7android13InputConsumer21initializeMotionEventEPNS_11MotionEventEPKNS_12InputMessageE:%llx&quot;</span>, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)sym_input);</span><br><span class="line">        <span class="built_in">DobbyHook</span>(sym_input, (<span class="type">void</span> *)new_input, (<span class="type">void</span> **)&amp;ori_input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 new_input 就可以得到系统输入了.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">new_input</span><span class="params">(<span class="type">void</span> *thiz, <span class="type">void</span> *a2, <span class="type">void</span> *a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ori_input)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;failed to get original input&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ori_input</span>(thiz, a2, a3);</span><br><span class="line">    <span class="comment">// LOGD(&quot;new_input&quot;);</span></span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;action:%d&quot;</span>, <span class="built_in">AMotionEvent_getAction</span>((AInputEvent *)thiz));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/02/Android-Hook-native%E5%B1%82%E8%8E%B7%E5%8F%96%E7%B3%BB%E7%BB%9F%E8%BE%93%E5%85%A5/log.png" alt="log"></p>
<p><strong>如果出现崩溃等 bug, 请检查是否是 DobbySymbolResolver 的问题，请指定第一个参数为 libinput.so 的路径</strong><br>
<strong>例如:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">void *sym_input = DobbySymbolResolver(&quot;system/lib/libinput.so&quot;,&quot;_ZN7android13InputConsumer21initializeMotionEventEPNS_11MotionEventEPKNS_12InputMessageE&quot;);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/" class="post-title-link" itemprop="url">Android外部imgui绘制(二)--补充</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-01 16:30:43" itemprop="dateCreated datePublished" datetime="2022-04-01T16:30:43+08:00">2022-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-06-10 14:21:14" itemprop="dateModified" datetime="2022-06-10T14:21:14+08:00">2022-06-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前几天看到评论区有个小伙伴问我，ue4 游戏怎么寻找 android_app 和获取系统输入.<br>
 我在这说一下.</p>
<h1 id="获取android_app"><a class="markdownIt-Anchor" href="#获取android_app"></a> 获取 android_app</h1>
<h2 id="基址偏移法"><a class="markdownIt-Anchor" href="#基址偏移法"></a> 基址偏移法</h2>
<p>首先，需要找到 libUE4.so 的 android_main 函数.<br>
<img src="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/android_main.png" alt="android_main"><br>
ida 进入 android_main 函数后按 F5,<br>
<img src="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/ida_f5.png" alt="ida_f5"><br>
 可以发现有一个全局变量保存了这个 android_app 变量.<br>
 那么它的地址就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libUE4.so(基址)+A36E1D0</span><br></pre></td></tr></table></figure>
<h2 id="注入hook法-magisk注入app并嵌入imgui"><a class="markdownIt-Anchor" href="#注入hook法-magisk注入app并嵌入imgui"></a> 注入 Hook 法 (Magisk 注入 app 并嵌入 imgui)</h2>
<p>参考了<a target="_blank" rel="noopener" href="https://0x.mk/?p=192"> Unity 全自动 hook 的实现</a><br>
 hook_each 等代码可以在这里找到:<br>
<a target="_blank" rel="noopener" href="https://github.com/kotori2/riru_unity_example">https://github.com/kotori2/riru_unity_example</a>.</p>
<p>直接 Hook libUE4.so 的 android_main 函数拿到 android_app 变量.<br>
1.Hook dl_open.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *loader_dlopen = <span class="built_in">DobbySymbolResolver</span>(<span class="literal">nullptr</span>, <span class="string">&quot;__dl__Z9do_dlopenPKciPK17android_dlextinfoPKv&quot;</span>);</span><br><span class="line"><span class="built_in">hook_each</span>((<span class="type">unsigned</span> <span class="type">long</span>)loader_dlopen, (<span class="type">void</span> *)dlopen_, (<span class="type">void</span> **)&amp;dlopen_backup);</span><br></pre></td></tr></table></figure>
<p>2. 在 dl_open 里拿到 libUE4.so 句柄并调用 dlsym 拿到 android_main 函数地址，然后 Hook android_main.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strstr</span>(name, <span class="string">&quot;libUE4.so&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        ue4_handle = handle;</span><br><span class="line">        <span class="built_in">LOGI</span>(<span class="string">&quot;Got libUE4.so handle at %lx&quot;</span>, (<span class="type">long</span>)ue4_handle);</span><br><span class="line">        <span class="built_in">hook_each</span>((<span class="type">unsigned</span> <span class="type">long</span>)<span class="built_in">dlsym</span>(ue4_handle, <span class="string">&quot;android_main&quot;</span>), (<span class="type">void</span> *)new_android_main, (<span class="type">void</span> **)&amp;ori_android_main);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>3. 在 Hook 后的 android_main 里保存 android_app.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">new_android_main</span><span class="params">(<span class="keyword">struct</span> android_app *app)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// LOGD(&quot;new_android_main&quot;);</span></span><br><span class="line">    g_App = app; <span class="comment">//这个g_App是一个全局变量,保存android_app.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == ori_android_main)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">LOGD</span>(<span class="string">&quot;failed to get original android_main&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ori_android_main</span>(app);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="获取输入"><a class="markdownIt-Anchor" href="#获取输入"></a> 获取输入</h1>
<p>先将原 android_app 的 onInputEvent 保存，然后替换为自己的 onInputEvent.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ori_onInputEvent = <span class="keyword">decltype</span>(ori_onInputEvent)(g_App-&gt;onInputEvent);</span><br><span class="line"><span class="built_in">LOGD</span>(<span class="string">&quot;ori_onInputEvent:%llx&quot;</span>, (<span class="type">long</span> <span class="type">long</span>)ori_onInputEvent);</span><br><span class="line">g_App-&gt;onInputEvent = onInputEvent;</span><br></pre></td></tr></table></figure>
<p>然后自己的 onInputEvent 就可以打印输入事件了.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">onInputEvent</span><span class="params">(<span class="keyword">struct</span> android_app *app, AInputEvent *inputEvent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;onInputEvent&quot;</span>);</span><br><span class="line">    <span class="type">int32_t</span> event_action = <span class="built_in">AMotionEvent_getAction</span>(inputEvent);</span><br><span class="line">    <span class="built_in">LOGD</span>(<span class="string">&quot;event_action:%d&quot;</span>, event_action);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ori_onInputEvent</span>(app, inputEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://pshocker.github.io/2022/04/01/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C-%E8%A1%A5%E5%85%85/log.png" alt="log"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shocker"
      src="/images/test.png">
  <p class="site-author-name" itemprop="name">Shocker</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://github.com/PShocker" title="https:&#x2F;&#x2F;github.com&#x2F;PShocker" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shocker</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
