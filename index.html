<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"pshocker.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Shocker">
<meta property="og:url" content="https://pshocker.github.io/index.html">
<meta property="og:site_name" content="Shocker">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Shocker">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://pshocker.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Shocker</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Shocker</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-mincore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-mincore/" class="post-title-link" itemprop="url">Android内存读写检测--mincore</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-08 23:57:07" itemprop="dateCreated datePublished" datetime="2022-05-08T23:57:07+08:00">2022-05-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-09 00:26:33" itemprop="dateModified" datetime="2022-05-09T00:26:33+08:00">2022-05-09</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Android另一种检测内存读写的方式–mincore</p>
<p>参考了这篇文章<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38944721/article/details/119471016">安卓手游安全-反外挂基础</a></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>引用上面文章的一句话</p>
<p><strong>回归主题，上面所述有个关键词叫缺页异常比如我们调用mmap来映射内存，为了防止内存无效分配，该内存空间在未访问时是不会创建物理内存页的。当程序需要使用这块内存区域时，会触发缺页中断，然后系统才会创建物理内存页。</strong></p>
<p>简而言之,就是先用mmap申请一段内存,如果ce,或GG读取这段内存后,那么这段内存就会由缺页变成非缺页.<br>而内存的缺页与否可以通过调用mincore判断.</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>1.mmap申请内存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">char * memory= nullptr;</span><br><span class="line">memory= (char*)mmap(nullptr,0x4000, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE, 0, 0);</span><br></pre></td></tr></table></figure>
<p>如果不对memory进行读写,那么memory默认为缺页状态</p>
<p>2.mincore判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int pageSize = getpagesize();</span><br><span class="line">unsigned char vec = 0;</span><br><span class="line">//memory[0]=1; 这个操作会把memory改为非缺页状态</span><br><span class="line">unsigned long addr= reinterpret_cast&lt;unsigned long&gt;(memory);</span><br><span class="line">unsigned long start = addr &amp; (~(pageSize - 1));</span><br><span class="line">mincore((void *)start, pageSize, &amp;vec);</span><br><span class="line">if (vec == 1)</span><br><span class="line">&#123;</span><br><span class="line">    LOGD(&quot;内存页：%p 存在于物理内存空间&quot;,addr);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    LOGD(&quot;内存页：%p 不存在于物理内存空间&quot;,addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>当ce指定读取该内存时,会发现该内存已经处于非缺页状态.</p>
<p>但是使用ce全局搜索内存时,并没有检测到这段内存.</p>
<p><img src="/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-mincore/1.png"></p>
<p>本文所用代码:<br><a target="_blank" rel="noopener" href="https://github.com/PShocker/Android_Mincore">https://github.com/PShocker/Android_Mincore</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-inotify/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-inotify/" class="post-title-link" itemprop="url">Android内存读写检测--inotify</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-08 16:55:22 / 修改时间：17:35:29" itemprop="dateCreated datePublished" datetime="2022-05-08T16:55:22+08:00">2022-05-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>关于安卓的内存读写检测,网上少之又少,我仅仅找到两篇我觉得比较可靠的.</p>
<p><a target="_blank" rel="noopener" href="http://t.csdn.cn/F417j">关于某蛇内核项目原理</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38944721/article/details/119471016">安卓手游安全-反外挂基础</a></p>
<p>特此记录一下.</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>app里使用inotify机制监控对内存的读写操作,引用百度百科的一句话.</p>
<p><strong>Inotify 是一个 Linux 内核特性，它监控文件系统，并且及时向专门的应用程序发出相关的事件警告，比如删除、读、写和卸载操作等。您还可以跟踪活动的源头和目标等细节。</strong></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>1.新建一个监控线程.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pthread_t ptMem, t, ptPageMap;</span><br><span class="line">int iRet = 0;</span><br><span class="line">iRet = pthread_create(&amp;ptPageMap, NULL, thread_watchInotifyDump, NULL);</span><br></pre></td></tr></table></figure>
<p>2.初始化监控</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">char dirName[NAME_MAX] = &#123;0&#125;;</span><br><span class="line">//snprintf(dirName, NAME_MAX, &quot;/proc/%d&quot;, getpid());</span><br><span class="line"></span><br><span class="line">//用于监控/proc/pid/mem的数据</span><br><span class="line">snprintf(dirName, NAME_MAX, &quot;/proc/%d/mem&quot;, getpid());</span><br><span class="line"></span><br><span class="line">LOGD(&quot;监控位置 : %s\n&quot;, dirName);</span><br><span class="line"></span><br><span class="line">int fd = inotify_init();</span><br><span class="line">if (fd &lt; 0)</span><br><span class="line">&#123;</span><br><span class="line">    LOGE(&quot;inotify_init err.\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">int wd = inotify_add_watch(fd, dirName, IN_ALL_EVENTS);</span><br><span class="line">if (wd &lt; 0)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    LOGE(&quot;inotify_add_watch err.\n&quot;);</span><br><span class="line">    close(fd);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.select读取监控消息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">const int buflen = sizeof(struct inotify_event) * 0x100;</span><br><span class="line">char buf[buflen] = &#123;0&#125;;</span><br><span class="line">fd_set readfds;</span><br><span class="line"></span><br><span class="line">int count[5] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">while (1)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    FD_ZERO(&amp;readfds);</span><br><span class="line"></span><br><span class="line">    FD_SET(fd, &amp;readfds);</span><br><span class="line"></span><br><span class="line">    int iRet = select(fd + 1, &amp;readfds, 0, 0, 0); // 此处阻塞</span><br><span class="line"></span><br><span class="line">    LOGD(&quot;iRet的返回值:%d\n&quot;, iRet);</span><br><span class="line">    if (-1 == iRet)</span><br><span class="line">        break;</span><br><span class="line"></span><br><span class="line">    if (iRet)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        memset(buf, 0, buflen);</span><br><span class="line">        int len = read(fd, buf, buflen);</span><br><span class="line"></span><br><span class="line">        int i = 0;</span><br><span class="line"></span><br><span class="line">        while (i &lt; len)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            struct inotify_event *event = (struct inotify_event *)&amp;buf[i];</span><br><span class="line"></span><br><span class="line">            LOGD(&quot;event mask:%d\n&quot;, event-&gt;mask);</span><br><span class="line"></span><br><span class="line">            if ((event-&gt;mask &amp; IN_ACCESS))</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                ++count[0];</span><br><span class="line">                LOGD(&quot;1.IN_ACCESS,第%d次.\n\n&quot;, count[0]);</span><br><span class="line"></span><br><span class="line">                //__asm __volatile(&quot;.int 0x8c89fa98&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((event-&gt;mask &amp; IN_OPEN))</span><br><span class="line">            &#123;</span><br><span class="line">                ++count[1];</span><br><span class="line">                LOGD(&quot;2.IN_OPEN,第%d次.\n\n&quot;,  count[1]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if ((event-&gt;mask &amp; IN_CLOSE))</span><br><span class="line">            &#123;</span><br><span class="line">                ++count[2];</span><br><span class="line">                LOGD(&quot;3.IN_CLOSE,第%d次.\n\n&quot;, count[2]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            i += sizeof(struct inotify_event) + event-&gt;len;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h2><p>当用ceserver读取内存时,发现会被检测到,GG和vm_read我懒得测了,理论上是有效果的.<br><img src="/2022/05/08/Android%E5%86%85%E5%AD%98%E8%AF%BB%E5%86%99%E6%A3%80%E6%B5%8B-inotify/1.png"></p>
<p>本文所用示例代码来自:<br><a target="_blank" rel="noopener" href="https://github.com/Reverse-Kindergarten/Android_Anti-Hcak_Inotify">https://github.com/Reverse-Kindergarten/Android_Anti-Hcak_Inotify</a></p>
<p><strong>谢谢isBaibai和SsageParuders两位大佬</strong></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/05/04/%E7%94%A8ollvm%E6%B7%B7%E6%B7%86native%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/04/%E7%94%A8ollvm%E6%B7%B7%E6%B7%86native%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">用ollvm混淆native代码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-04 10:02:47" itemprop="dateCreated datePublished" datetime="2022-05-04T10:02:47+08:00">2022-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-05 12:18:26" itemprop="dateModified" datetime="2022-05-05T12:18:26+08:00">2022-05-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文只是对<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41923691/article/details/123258565">【清羽】Windows10下编译OLLVM-14.x</a>的用法做记录,不涉及任何原理分析.</p>
<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><p>1.ndk<br>原文里大佬用的是ndk25.<br><a target="_blank" rel="noopener" href="https://dl.google.com/android/repository/android-ndk-r25-beta3-windows.zip">https://dl.google.com/android/repository/android-ndk-r25-beta3-windows.zip</a></p>
<p>2.<a target="_blank" rel="noopener" href="https://github.com/mstorsjo/llvm-mingw">llvm-mingw64</a><br><a target="_blank" rel="noopener" href="https://github.com/mstorsjo/llvm-mingw/releases/download/20220323/llvm-mingw-20220323-ucrt-x86_64.zip">https://github.com/mstorsjo/llvm-mingw/releases/download/20220323/llvm-mingw-20220323-ucrt-x86_64.zip</a><br>解压后把</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...(你解压的文件夹)\llvm-mingw-20220323-ucrt-x86_64\bin</span><br></pre></td></tr></table></figure>
<p>配到环境变量里,<strong>否则会提示找不到libc++.dll等</strong>.</p>
<p>3.clang<br>下载大佬已经编译好的clang<br><a target="_blank" rel="noopener" href="https://gitee.com/qingyu_yyy/ollvm-project/attach_files/985049/download/clang-14.0.0.zip">https://gitee.com/qingyu_yyy/ollvm-project/attach_files/985049/download/clang-14.0.0.zip</a><br>解压后把clang.exe这个复制3份,分别命名为clang.exe,clang++.exe,clang-cl.exe.<br>粘贴到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...\android-ndk-r25-beta3\toolchains\llvm\prebuilt\windows-x86_64\bin\</span><br></pre></td></tr></table></figure>
<p>里</p>
<p>4.复制 lib 库<br>把</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...\android-ndk-r25-beta3\toolchains\llvm\prebuilt\windows-x86_64\lib64\clang</span><br></pre></td></tr></table></figure>
<p>复制到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...\android-ndk-r25-beta3\toolchains\llvm\prebuilt\windows-x86_64\lib\</span><br></pre></td></tr></table></figure>
<p>里.<br>然后把该文件夹的14.0.1改成14.0.0</p>
<h2 id="编译使用"><a href="#编译使用" class="headerlink" title="编译使用"></a>编译使用</h2><p>1.Android.mk<br>加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOCAL_CFLAGS += -mllvm -sub -mllvm -bcf -mllvm -fla</span><br></pre></td></tr></table></figure>
<p>2.CMakeLists.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set(CMAKE_CXX_FLAGS &quot;-mllvm -fla -mllvm -sub -mllvm -sobf&quot;)</span><br></pre></td></tr></table></figure>
<p>在Android studio指定ndk路径local.properties.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ndk.dir=C\:\\Users\\Shocker\\AppData\\Local\\Android\\Sdk\\ndk\\android-ndk-r25-beta3</span><br></pre></td></tr></table></figure>
<p><strong>貌似在Android studio加上-mllvm -bcf编译卡死.</strong><br>可以在外面ndk-build后拖进项目里.</p>
<p><img src="/2022/05/04/%E7%94%A8ollvm%E6%B7%B7%E6%B7%86native%E4%BB%A3%E7%A0%81/res.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" class="post-title-link" itemprop="url">小米12(pro)内核模块编译--环境配置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-27 13:47:10 / 修改时间：17:41:23" itemprop="dateCreated datePublished" datetime="2022-04-27T13:47:10+08:00">2022-04-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>很早之前,我看到过一份珍贵无比的代码<br><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-259317.htm">开源一个Linux内核里进程内存管理模块源码</a></p>
<p>github地址:<br><a target="_blank" rel="noopener" href="https://github.com/abcz316/rwProcMem33">https://github.com/abcz316/rwProcMem33</a></p>
<p>涉及到<strong>内核读写,硬件断点</strong>,很强势!</p>
<p>直接开干就完事了.</p>
<p>我的编译环境:wsl(Ubuntu 18.04)</p>
<h2 id="下载源代码-编译工具"><a href="#下载源代码-编译工具" class="headerlink" title="下载源代码,编译工具"></a>下载源代码,编译工具</h2><p>参考:<br><a target="_blank" rel="noopener" href="https://github.com/MiCode/Xiaomi_Kernel_OpenSource/issues/957">https://github.com/MiCode/Xiaomi_Kernel_OpenSource/issues/957</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev libwxgtk3.0-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev unzip openjdk-8-jdk language-pack-zh-hans</span><br></pre></td></tr></table></figure>

<p>下载小米12内核源码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone --depth=1 https://github.com/MiCode/Xiaomi_Kernel_OpenSource -b zeus-s-oss</span><br></pre></td></tr></table></figure>
<p>如果没有代理,不建议git clone,因为太慢了.</p>
<p>打开这个网站:<br><a target="_blank" rel="noopener" href="https://d.serctl.com/?dl_start">https://d.serctl.com/?dl_start</a></p>
<p>下载内核的压缩包<br><a target="_blank" rel="noopener" href="https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/zeus-s-oss.zip">https://github.com/MiCode/Xiaomi_Kernel_OpenSource/archive/refs/heads/zeus-s-oss.zip</a></p>
<p>下载clang编译器:<br><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/master">https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+/master</a><br>(魔法上网)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export ARCH=arm64</span><br><span class="line">export SUBARCH=arm64</span><br><span class="line">export CROSS_COMPILE=/home/shocker/aosp12/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/bin/aarch64-linux-android-</span><br></pre></td></tr></table></figure>

<p>CROSS_COMPILE是我之前编译aosp的时候用的,源码里自带的.</p>
<p>编译命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make O=out CC=/home/shocker/clang/bin/clang CLANG_TRIPLE=aarch64-linux-android- generic_vm_defconfig</span><br><span class="line">make -j$(nproc) O=out CC=/home/shocker/clang/bin/clang  CLANG_TRIPLE=aarch64-linux-android- </span><br></pre></td></tr></table></figure>

<h2 id="踩坑记录"><a href="#踩坑记录" class="headerlink" title="踩坑记录"></a>踩坑记录</h2><p>重点来了,小米12的内核会缺很多文件,必须手动把每个错误都处理掉.</p>
<h3 id="错误一"><a href="#错误一" class="headerlink" title="错误一"></a>错误一</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drivers/misc/Kconfig:540: can&#x27;t open file &quot;drivers/misc/hwid/Kconfig&quot;</span><br></pre></td></tr></table></figure>
<p>打开drivers&#x2F;misc&#x2F;Kconfig删掉540行的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &quot;drivers/misc/hwid/Kconfig&quot;</span><br></pre></td></tr></table></figure>

<h3 id="错误二"><a href="#错误二" class="headerlink" title="错误二"></a>错误二</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">../scripts/Makefile.build:44: ../drivers/misc/hwid/Makefile: No such file or directory</span><br><span class="line">make[4]: *** No rule to make target &#x27;../drivers/misc/hwid/Makefile&#x27;.  Stop.</span><br><span class="line">../scripts/Makefile.build:520: recipe for target &#x27;drivers/misc/hwid&#x27; failed</span><br><span class="line">make[3]: *** [drivers/misc/hwid] Error 2</span><br><span class="line">../scripts/Makefile.build:520: recipe for target &#x27;drivers/misc&#x27; failed</span><br><span class="line">make[2]: *** [drivers/misc] Error 2</span><br><span class="line">/home/shocker/kernel/Xiaomi_Kernel_OpenSource-zeus-s-oss/Makefile:1931: recipe for target &#x27;drivers&#x27; failed</span><br></pre></td></tr></table></figure>
<p>修改.&#x2F;drivers&#x2F;misc&#x2F;Makefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./drivers/misc/Makefile</span><br></pre></td></tr></table></figure>
<p>注释所有带hwid的行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ccflags-y += -I$(srctree)/drivers/misc/hwid/</span><br><span class="line">#obj-y                          += hwid/</span><br></pre></td></tr></table></figure>
<h3 id="错误三"><a href="#错误三" class="headerlink" title="错误三"></a>错误三</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_interface.h:11:10: fatal error: &#x27;media/cam_req_mgr.h&#x27; file not found</span><br><span class="line">#include &lt;media/cam_req_mgr.h&gt;</span><br><span class="line">         ^~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">../scripts/Makefile.build:277: recipe for target &#x27;techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_core.o&#x27; failed</span><br><span class="line">make[3]: *** [techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_core.o] Error 1</span><br><span class="line">make[3]: *** Waiting for unfinished jobs....</span><br><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.c:13:10: fatal error: &#x27;mm/slab.h&#x27; file not found</span><br><span class="line">#include &lt;mm/slab.h&gt;</span><br><span class="line">         ^~~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">../scripts/Makefile.build:277: recipe for target &#x27;techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.o&#x27; failed</span><br><span class="line">make[3]: *** [techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_dev.o] Error 1</span><br><span class="line">../techpack/camera-kernel/drivers/cam_req_mgr/cam_req_mgr_util.c:15:10: fatal error: &#x27;media/cam_req_mgr.h&#x27; file not found</span><br><span class="line">#include &lt;media/cam_req_mgr.h&gt;</span><br></pre></td></tr></table></figure>
<p>把.&#x2F;techpack&#x2F;camera-kernel&#x2F;删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -r techpack/camera-kernel/</span><br></pre></td></tr></table></figure>

<h3 id="错误四"><a href="#错误四" class="headerlink" title="错误四"></a>错误四</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">../drivers/android/vendor_hooks.c:42:10: fatal error: &#x27;trace/hooks/thermal.h&#x27; file not found</span><br><span class="line">#include &lt;trace/hooks/thermal.h&gt;</span><br></pre></td></tr></table></figure>
<p>注释掉所有引用到thermal.h的地方</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./drivers/android/vendor_hooks.c</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//#include &lt;trace/hooks/thermal.h&gt;</span><br><span class="line">//EXPORT_TRACEPOINT_SYMBOL_GPL(android_vh_enable_thermal_genl_check);</span><br><span class="line">//EXPORT_TRACEPOINT_SYMBOL_GPL(android_vh_thermal_pm_notify_suspend);</span><br></pre></td></tr></table></figure>

<p>然后就编译完成了<br><img src="/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/res.png"></p>
<h2 id="编译模块"><a href="#编译模块" class="headerlink" title="编译模块"></a>编译模块</h2><p>一个最简单的内核模块<br>hello.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;linux/init.h&gt;</span><br><span class="line">#include &lt;linux/module.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">static int hello_init(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_WARNING&quot;Hello world!\n&quot;);</span><br><span class="line">    return 0;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static void hello_exit(void)</span><br><span class="line">&#123;</span><br><span class="line">    printk(KERN_WARNING&quot;hello exit!\n&quot;);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br><span class="line">MODULE_LICENSE(&quot;GPL&quot;);</span><br></pre></td></tr></table></figure>

<p>Makefile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj-m := hello.o</span><br><span class="line">KDIR := /home/shocker/Xiaomi_Kernel_OpenSource-zeus-s-oss/out</span><br><span class="line">CFLAGS_MODULE=-fno-pic</span><br><span class="line">ARCH=arm64</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">	make -C $(KDIR) M=$(PWD) modules </span><br><span class="line">clean:    </span><br><span class="line">	rm -f *.ko *.o *.mod.o *.mod.c *.symvers *.order</span><br></pre></td></tr></table></figure>


<p>编译命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(nproc) CC=/home/shocker/clang/bin/clang  CLANG_TRIPLE=aarch64-linux-android-</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/27/%E5%B0%8F%E7%B1%B312-pro-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E7%BC%96%E8%AF%91-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ko.png"></p>
<p>github地址:<br><a target="_blank" rel="noopener" href="https://github.com/PShocker/hellokernel">https://github.com/PShocker/hellokernel</a></p>
<p>参考了泓清大佬的文章:<br><a target="_blank" rel="noopener" href="https://blog.hongqing.online/android/BuildAndroidKernel/">【Android Kernel】编译总结</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/" class="post-title-link" itemprop="url">Android外部imgui绘制--JNIRoot?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-21 15:33:44" itemprop="dateCreated datePublished" datetime="2022-04-21T15:33:44+08:00">2022-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-23 22:05:58" itemprop="dateModified" datetime="2022-04-23T22:05:58+08:00">2022-04-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>前几天听说了个jniroot,貌似很厉害的样子<br><a target="_blank" rel="noopener" href="https://github.com/topjohnwu/libsu">https://github.com/topjohnwu/libsu</a></p>
<p>想着能不能适配imgui.<br>干就完事了.<br><img src="/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/gif.gif"></p>
<p><strong>改进后的libsu模板在这里</strong><br><strong><a target="_blank" rel="noopener" href="https://github.com/PShocker/libsutemplate">https://github.com/PShocker/libsutemplate</a></strong></p>
<p>1.新建Native C++项目,把libsu的依赖全部加进去</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        // This library uses Java 8 features, this is required</span><br><span class="line">        sourceCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">        targetCompatibility JavaVersion.VERSION_1_8</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">repositories &#123;</span><br><span class="line">    maven &#123; url &#x27;https://jitpack.io&#x27; &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    def libsuVersion = &#x27;4.0.3&#x27;</span><br><span class="line"></span><br><span class="line">    // The core module is used by all other components</span><br><span class="line">    implementation &quot;com.github.topjohnwu.libsu:core:$&#123;libsuVersion&#125;&quot;</span><br><span class="line"></span><br><span class="line">    // Optional: APIs for creating root services</span><br><span class="line">    implementation &quot;com.github.topjohnwu.libsu:service:$&#123;libsuVersion&#125;&quot;</span><br><span class="line"></span><br><span class="line">    // Optional: For com.topjohnwu.superuser.io classes</span><br><span class="line">    implementation &quot;com.github.topjohnwu.libsu:io:$&#123;libsuVersion&#125;&quot;</span><br><span class="line"></span><br><span class="line">    // Optional: Bundle prebuilt BusyBox binaries</span><br><span class="line">    implementation &quot;com.github.topjohnwu.libsu:busybox:$&#123;libsuVersion&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若报错,把maven { url ‘<a target="_blank" rel="noopener" href="https://jitpack.io&/#39;">https://jitpack.io&#39;</a> }添加到settings.gradle里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dependencyResolutionManagement &#123;</span><br><span class="line">    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        maven &#123; url &#x27;https://jitpack.io&#x27; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.新建aidl文件,Rebuild生成 Stub文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface IImGuiService &#123;</span><br><span class="line">    /**</span><br><span class="line">     * Demonstrates some basic types that you can use as parameters</span><br><span class="line">     * and return values in AIDL.</span><br><span class="line">     */</span><br><span class="line">    void init_ImGui(inout Surface surface);</span><br><span class="line">    void update_ImGui(int width, int height);</span><br><span class="line">    void set_ImGui_Orientation(int orientation);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>新建AIDLService类,继承RootService.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">class AIDLService extends RootService &#123;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        // Only load the library when this class is loaded in a root process.</span><br><span class="line">        // The classloader will load this class (and call this static block) in the non-root</span><br><span class="line">        // process because we accessed it when constructing the Intent to send.</span><br><span class="line">        // Add this check so we don&#x27;t unnecessarily load native code that&#x27;ll never be used.</span><br><span class="line">        if (Process.myUid() == 0)</span><br><span class="line">            System.loadLibrary(&quot;imgui&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public  native void native_init_ImGui(Surface surface); //imgui初始化,读取输入,渲染.</span><br><span class="line">    public  native void native_update_ImGui(int width, int height);</span><br><span class="line">    public  native void native_set_ImGui_Orientation(int orientation); //设置屏幕方向</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class ImGui extends IImGuiService.Stub &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void init_ImGui(Surface surface) throws RemoteException &#123;</span><br><span class="line">            native_init_ImGui(surface);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void update_ImGui(int width, int height) throws RemoteException &#123;</span><br><span class="line">            native_update_ImGui(width,height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void set_ImGui_Orientation(int orientation) throws RemoteException &#123;</span><br><span class="line">            native_set_ImGui_Orientation(orientation);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public IBinder onBind(@NonNull Intent intent) &#123;</span><br><span class="line">        return new ImGui();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.新建ImGuiView类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class ImGuiView extends SurfaceView implements SurfaceHolder.Callback&#123;</span><br><span class="line">   public ImGuiView(Context context) &#123;</span><br><span class="line">      super(context);</span><br><span class="line">      setZOrderOnTop(true);</span><br><span class="line">      SurfaceHolder holder = getHolder();</span><br><span class="line">      holder.setFormat(PixelFormat.TRANSLUCENT);</span><br><span class="line">      getHolder().addCallback(this);</span><br><span class="line">      setFocusable(true);</span><br><span class="line">      setFocusableInTouchMode(true);</span><br><span class="line">      requestFocus();</span><br><span class="line">      requestFocusFromTouch();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void surfaceCreated(@NonNull SurfaceHolder surfaceHolder) &#123;</span><br><span class="line">      Log.d(&quot;Shocker&quot;,&quot;surfaceCreated&quot;); //这里需要新线程在native里完成初始化,读取输入和渲染</span><br><span class="line">         new Thread(new Runnable() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">               try &#123;</span><br><span class="line">                  MainActivity.ImGui.init_ImGui(surfaceHolder.getSurface());</span><br><span class="line">               &#125; catch (RemoteException e) &#123;</span><br><span class="line">                  e.printStackTrace();</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;).start();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void surfaceChanged(@NonNull SurfaceHolder surfaceHolder, int i, int i1, int i2) &#123;</span><br><span class="line">       ....... //处理屏幕旋转事件</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   @Override</span><br><span class="line">   public void surfaceDestroyed(@NonNull SurfaceHolder surfaceHolder) &#123;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.新建AIDLConnection类,在MainActivity的OnCreate里绑定RootService</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public static IImGuiService ImGui;</span><br><span class="line">class AIDLConnection implements ServiceConnection &#123;</span><br><span class="line"></span><br><span class="line">        private final boolean isDaemon;</span><br><span class="line"></span><br><span class="line">        AIDLConnection(boolean b) &#123;</span><br><span class="line">            isDaemon = b;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceConnected(ComponentName name, IBinder service) &#123;</span><br><span class="line">            ImGui= IImGuiService.Stub.asInterface(service);</span><br><span class="line">            Log.d(&quot;Shocker&quot;,&quot;Connected&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onServiceDisconnected(ComponentName componentName) &#123;</span><br><span class="line">            Log.d(&quot;Shocker&quot;,&quot;Disconnected&quot;);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected void onCreate(Bundle savedInstanceState) &#123;</span><br><span class="line">        ..............</span><br><span class="line">        RootService.bind(new Intent(this, AIDLService.class), new AIDLConnection(false));</span><br><span class="line">        t.setOnClickListener(view -&gt; &#123;</span><br><span class="line">            if (!start)&#123;</span><br><span class="line">                addFullView(); //添加悬浮窗</span><br><span class="line">                start=true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>5.native完成imgui初始化,循环读取输入和渲染</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Java_com_shocker_imgui_AIDLService_native_1init_1ImGui(JNIEnv *env, jobject thiz, jobject surface) &#123;</span><br><span class="line">    ANativeWindow* w = ANativeWindow_fromSurface(env, (jobject)surface);</span><br><span class="line">    init(w); //初始化imgui</span><br><span class="line">    ANativeWindow_release(w);</span><br><span class="line"></span><br><span class="line">    while (true)&#123;</span><br><span class="line">        handleInputEvent();</span><br><span class="line">        tick();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/04/21/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-JNIRoot/pic.jpg"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/17/Android%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87%E6%AF%94%E8%BE%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/17/Android%E8%AF%BB%E5%86%99%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87%E6%AF%94%E8%BE%83/" class="post-title-link" itemprop="url">Android读写内存效率比较</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-17 14:15:22 / 修改时间：18:39:01" itemprop="dateCreated datePublished" datetime="2022-04-17T14:15:22+08:00">2022-04-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>众所周知,安卓平台读写内存的方式有</p>
<p>1.read write &#x2F;proc&#x2F;xx&#x2F;mem 文件<br>2.ptrace<br>3.syscall<br>4.注入读写(Magisk注入)</p>
<p>那么他们谁的读写效率更高呢?</p>
<p>测试方法很简单.读写100000次,记录时间差</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">clock_gettime(CLOCK_MONOTONIC, &amp;old);</span><br><span class="line">for (size_t i = 0; i &lt; 100000; i++)</span><br><span class="line">&#123;</span><br><span class="line">..............</span><br><span class="line">..............</span><br><span class="line">&#125;</span><br><span class="line">clock_gettime(CLOCK_MONOTONIC, &amp;now);</span><br><span class="line">cout &lt;&lt; &quot;time passed is: &quot; &lt;&lt; (now.tv_sec - old.tv_sec) * 1000 + (now.tv_nsec - old.tv_nsec) / 1000000 &lt;&lt; &quot;ms&quot; &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<p>以下是分别测试读写100000次所需要的时间</p>
<table border="0" cellpadding="0" cellspacing="0" width="646" style="border-collapse:
 collapse;table-layout:fixed;width:485pt">
 <col width="64" style="width:48pt">
 <col width="146" style="mso-width-source:userset;mso-width-alt:5176;width:109pt">
 <col width="156" style="mso-width-source:userset;mso-width-alt:5546;width:117pt">
 <col width="150" style="mso-width-source:userset;mso-width-alt:5347;width:113pt">
 <col width="130" style="mso-width-source:userset;mso-width-alt:4636;width:98pt">
 <tr height="18" style="height:13.8pt">
  <td height="18" width="64" style="height:13.8pt;width:48pt"></td>
  <td width="146" style="width:109pt">mem</td>
  <td width="156" style="width:117pt">ptrace</td>
  <td width="150" style="width:113pt">syscall</td>
  <td width="130" style="width:98pt">注入读写</td>
 </tr>
 <tr height="18" style="height:13.8pt">
  <td height="18" style="height:13.8pt">读</td>
  <td>155ms</td>
  <td>2983ms</td>
  <td>101ms</td>
  <td>0.000069ms</td>
 </tr>
 <tr height="18" style="height:13.8pt">
  <td height="18" style="height:13.8pt">写</td>
  <td>416ms</td>
  <td>2940ms</td>
  <td>88ms</td>
  <td>0.000243ms</td>
 </tr>
</table>

<p>可以看出,效率最快的是注入读写,比syscall和读mem快了近1000000倍.</p>
<p>而ptrace效率低很大程度上因为ptrace的PTRACE_ATTACH和PTRACE_DETACH消耗了大量时间.</p>
<p>读写效率:<br>注入读写 &gt;&gt; syscall &gt; mem &gt; ptrace</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/" class="post-title-link" itemprop="url">Hook surfaceflinger进程给surface开后门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-16 14:21:03 / 修改时间：14:51:41" itemprop="dateCreated datePublished" datetime="2022-04-16T14:21:03+08:00">2022-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>对于可执行文件创建的surface来说.它的uid和pid都为0.</p>
<p>对于app内部创建的surface来说.它的uid和pid都不为0.</p>
<p>见<a href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/">Magisk注入app并嵌入imgui(三)</a></p>
<p>我们只需要找到app创建的surface,并把它的pid和uid改成0,就可以实现可执行文件的效果.</p>
<p>1.注入surfaceflinger进程<br>参考:<a target="_blank" rel="noopener" href="https://github.com/PShocker/AndroidPtraceInject_surfaceflinger">AndroidPtraceInject_surfaceflinger</a><br>参考:<a target="_blank" rel="noopener" href="https://github.com/SsageParuders/AndroidPtraceInject">AndroidPtraceInject</a></p>
<p>2.Dobby hook createSurface</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int hook_createSurface()</span><br><span class="line">&#123;</span><br><span class="line">    LOGD(&quot;hook_createSurface start\n&quot;);</span><br><span class="line">    void *sym = DobbySymbolResolver(NULL, &quot;_ZN7android6Client13createSurfaceERKNS_7String8EjjijRKNS_2spINS_7IBinderEEENS_13LayerMetadataEPS6_PNS4_INS_22IGraphicBufferProducerEEEPiPj&quot;);</span><br><span class="line">    if (NULL != sym)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGD(&quot;_ZN7android6Client13createSurfaceERKNS_7String8EjjijRKNS_2spINS_7IBinderEEENS_13LayerMetadataEPS6_PNS4_INS_22IGraphicBufferProducerEEEPiPj:%llx&quot;, (unsigned long long)sym);</span><br><span class="line">        DobbyHook(sym, (void *)new_createSurface, (void **)&amp;ori_createSurface);</span><br><span class="line">    &#125;</span><br><span class="line">    LOGD(&quot;hook_createSurface finish\n&quot;);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.从surface的name拿到想要hook的surface的pid和uid</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int64_t new_createSurface(void *thiz, void *a2, void *a3, void *a4, void *a5, void *a6, void *a7, void *a8, void *a9, void *a10, void *a11, void *a12)</span><br><span class="line">&#123;</span><br><span class="line">    // LOGD(&quot;new_createSurface&quot;);</span><br><span class="line">    if (NULL == ori_createSurface)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGE(&quot;failed to get original new_createSurface&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    LOGD(&quot;str:%llx&quot;, *(unsigned long long *)*(unsigned long long *)a2);</span><br><span class="line"></span><br><span class="line">    if (*(unsigned long long *)*(unsigned long long *)a2 == 0x72656b636f6853) //这里根据surface的名字来判断是否是要Hook的surface.strcmp()会闪退,只能用字符串的16进制来比较.</span><br><span class="line">    &#123;</span><br><span class="line">        LOGD(&quot;getCallingPid:%d&quot;, getCallingPid());</span><br><span class="line">        LOGD(&quot;getCallingUid:%d&quot;, getCallingUid());</span><br><span class="line">        Hook_Pid = getCallingPid(); //这里拿到Pid</span><br><span class="line">        Hook_Uid = getCallingUid(); //Uid</span><br><span class="line">    &#125;</span><br><span class="line">    return ori_createSurface(thiz, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4.Dobby hook getCallingPid和getCallingUid<br>Hook代码省略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int64_t new_getCallingPid(void *thiz)</span><br><span class="line">&#123;</span><br><span class="line">    // LOGD(&quot;new_getCallingPid&quot;);</span><br><span class="line">    if (NULL == ori_getCallingPid)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGE(&quot;failed to get original new_getCallingPid&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    int Pid = ori_getCallingPid(thiz);</span><br><span class="line">    if (Pid == Hook_Pid)</span><br><span class="line">    &#123;</span><br><span class="line">        Hook_Uid = getCallingUid(); //更新Uid</span><br><span class="line">        return 0; //如果是我们创建的surface,就返回0</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return Pid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static int64_t new_getCallingUid(void *thiz)</span><br><span class="line">&#123;</span><br><span class="line">    // LOGD(&quot;new_getCallingUid&quot;);</span><br><span class="line">    if (NULL == ori_getCallingUid)</span><br><span class="line">    &#123;</span><br><span class="line">        LOGE(&quot;failed to get original new_getCallingUid&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">    int Uid = ori_getCallingUid(thiz);</span><br><span class="line">    if (Uid == Hook_Uid)</span><br><span class="line">    &#123;</span><br><span class="line">        // LOGE(&quot;Hook Uid&quot;);</span><br><span class="line">        return 0; // 如果是我们创建的surface,就返回0</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        return Uid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getCallingPid()和getCallingUid()可以在aosp环境里封装一个.a的静态库<br>编译的时候链接就行.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int getCallingPid()</span><br><span class="line">&#123;</span><br><span class="line">    IPCThreadState *ipc = IPCThreadState::self();</span><br><span class="line">    return ipc-&gt;getCallingPid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int getCallingUid()</span><br><span class="line">&#123;</span><br><span class="line">    IPCThreadState *ipc = IPCThreadState::self();</span><br><span class="line">    return ipc-&gt;getCallingUid();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/" class="post-title-link" itemprop="url">Magisk注入app并嵌入imgui(三)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-04-16 11:26:19 / 修改时间：14:57:02" itemprop="dateCreated datePublished" datetime="2022-04-16T11:26:19+08:00">2022-04-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在<a href="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/">Magisk注入app并嵌入imgui(二)</a>里成功创建了surface,但是imgui的画面并没有显示出来,<br><img src="/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/why.jpg"></p>
<p>看看SurfaceFlinger的信息.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys SurfaceFlinger</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/layers.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Offscreen Layers:</span><br><span class="line">Layer Surface(name=cac9055 InputMethod)/@0x5406b5b - animation-leash of insets_animation#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=50f3462 com.tencent.mf.uam/com.epicgames.ue4.GameActivity)/@0x5e8236 - animation-leash of starting_reveal#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=Task=1)/@0xca72fe0 - animation-leash of app_transition#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Surface(name=Task=185)/@0xc4029e3 - animation-leash of app_transition#0 (EffectLayer) callingPid:3013 callingUid:1000 ownerUid:1000</span><br><span class="line">Layer Shocker#0 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br><span class="line">Layer bbq-wrapper#1 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br></pre></td></tr></table></figure>
<p>唉,我的Layer怎么在Offscreen里?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Layer Shocker#0 (BufferStateLayer) callingPid:8669 callingUid:10219 ownerUid:10219</span><br></pre></td></tr></table></figure>

<p>打开imgui可执行文件的版本.<br>看看有什么区别.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+ BufferStateLayer (ImGuiLink#0  screenFlags = 0  miuiVkWidgetTransparent = 0) uid=0</span><br><span class="line">  Region TransparentRegion (this=0 count=0)</span><br><span class="line">  Region VisibleRegion (this=0 count=0)</span><br><span class="line">  Region SurfaceDamageRegion (this=0 count=0)</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(  -1,  -1), crop=[  0,   0,  -1,  -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=0, dataspace=Default, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000000, tr=[0.00, 0.00][0.00, 0.00]</span><br><span class="line">      parent=none</span><br><span class="line">      zOrderRelativeOf=none</span><br><span class="line">      activeBuffer=[   0x   0:   0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata=&#123;&#125;, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00],  shadowRadius=0.000,</span><br><span class="line">+ BufferStateLayer (bbq-wrapper#0  screenFlags = 0  miuiVkWidgetTransparent = 0) uid=0</span><br><span class="line">  Region TransparentRegion (this=0 count=0)</span><br><span class="line">  Region VisibleRegion (this=0 count=1)</span><br><span class="line">    [  0,   0, 1440, 3200]</span><br><span class="line">  Region SurfaceDamageRegion (this=0 count=0)</span><br><span class="line">      layerStack=   0, z=        0, pos=(0,0), size=(1440,3200), crop=[  0,   0,  -1,  -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=0, dataspace=Default, defaultPixelFormat=RGBA_8888, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000100, tr=[0.00, 0.00][0.00, 0.00]</span><br><span class="line">      parent=ImGuiLink#0  screenFlags = 0  miuiVkWidgetTransparent = 0</span><br><span class="line">      zOrderRelativeOf=none</span><br><span class="line">      activeBuffer=[1440x3200:1472,RGBA_8888], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata=&#123;dequeueTime:514178138135&#125;, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00],  shadowRadius=0.000,</span><br></pre></td></tr></table></figure>
<p>唉,发现可执行文件的uid&#x3D;0而,app创建的surface的uid不为0.</p>
<p>去源码看看.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4353      bool addToRoot = callingThreadHasUnscopedSurfaceFlingerAccess();</span><br><span class="line">4354      result = addClientLayer(client, *handle, *gbp, layer, parentHandle, parentLayer, addToRoot,</span><br><span class="line">4355                              outTransformHint);</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/s?refs=createLayer&amp;project=frameworks">http://aospxref.com/android-12.0.0_r3/s?refs=createLayer&amp;project=frameworks</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">3888  bool SurfaceFlinger::callingThreadHasUnscopedSurfaceFlingerAccess(bool usePermissionCache) &#123;</span><br><span class="line">3889      IPCThreadState* ipc = IPCThreadState::self();</span><br><span class="line">3890      const int pid = ipc-&gt;getCallingPid();</span><br><span class="line">3891      const int uid = ipc-&gt;getCallingUid();</span><br><span class="line">3892      if ((uid != AID_GRAPHICS &amp;&amp; uid != AID_SYSTEM) &amp;&amp;</span><br><span class="line">3893          (usePermissionCache ? !PermissionCache::checkPermission(sAccessSurfaceFlinger, pid, uid)</span><br><span class="line">3894                              : !checkPermission(sAccessSurfaceFlinger, pid, uid))) &#123;</span><br><span class="line">3895          return false;</span><br><span class="line">3896      &#125;</span><br><span class="line">3897      return true;</span><br><span class="line">3898  &#125;</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="http://aospxref.com/android-12.0.0_r3/s?refs=callingThreadHasUnscopedSurfaceFlingerAccess&amp;project=frameworks">http://aospxref.com/android-12.0.0_r3/s?refs=callingThreadHasUnscopedSurfaceFlingerAccess&amp;project=frameworks</a></p>
<p>这里的pid,uid就是通过下面的函数获取的.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3890      const int pid = ipc-&gt;getCallingPid();</span><br><span class="line">3891      const int uid = ipc-&gt;getCallingUid();</span><br></pre></td></tr></table></figure>

<p>对于可执行文件来说,pid和uid都是0.</p>
<p>那么有没有办法让我们创建的surface pid和uid同时为0呢?</p>
<p>当然有…<br><a href="https://pshocker.github.io/2022/04/16/Hook-surfaceflinger%E8%BF%9B%E7%A8%8B%E7%BB%99surface%E5%BC%80%E5%90%8E%E9%97%A8/">Hook surfaceflinger进程给surface开后门</a></p>
<p>最后做一个总结:<br>相比于外部imgui,hook eglswapbuffers来说,creteSurface基本上是最优解,它既不会涉及到跨进程读写内存,也不会卡游戏画面.<br>唯一美中不足的地方就是编译复杂,没法跨安卓版本使用.</p>
<p><img src="/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/dog.gif"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/" class="post-title-link" itemprop="url">Magisk注入app并嵌入imgui(二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-15 22:49:47" itemprop="dateCreated datePublished" datetime="2022-04-15T22:49:47+08:00">2022-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-04-16 15:01:22" itemprop="dateModified" datetime="2022-04-16T15:01:22+08:00">2022-04-16</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前我写过一篇文章介绍了<a href="https://pshocker.github.io/2022/03/21/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui/">Magisk注入app并嵌入imgui</a>.<br>其原理就是Hook app进程的eglSwapBuffers函数.在其中完成imgui的初始化的显示.</p>
<p>但我测试UE4游戏的时候发现,要么画面出不来,要么就闪退.<br>大概率是和引擎冲突了…<br>淦.<br><img src="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/g.jpg"></p>
<p>没办法,那么就创建一个surface.<br>注意,createSurface等函数需要aosp环境.所以需要在<strong>aosp环境里编译zygisk模块.</strong></p>
<h2 id="环境和工具"><a href="#环境和工具" class="headerlink" title="环境和工具"></a>环境和工具</h2><p>1.Android 12环境(版本可根据自己真机版本选择,硬盘空间最好大于250G,不然拉取失败会出现很多问题)<br>2.wsl或虚拟机(wsl Ubuntu18.04)<br>3.安卓真机(小米12)</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><h3 id="下载Android12-编译Android12"><a href="#下载Android12-编译Android12" class="headerlink" title="下载Android12,编译Android12."></a>下载Android12,编译Android12.</h3><p>这些网上有很多教学,值得一提的是,相比Android5,新版本编译的时候没有什么错误,基本上一次过.很爽.</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/grackergao/article/details/120984766">Android 系统开发系列（1）：Android 12 源代码下载、编译和刷机</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68918808">死磕Android_AOSP编译过程</a></p>
<p><strong>注意:硬盘剩余空间一定要大于250g,硬盘剩余空间一定要大于250g,硬盘剩余空间一定要大于250g</strong><br><strong>否则失败了会很麻烦.</strong></p>
<p><img src="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/kk.jpg"></p>
<h3 id="复制源文件到Android源码里"><a href="#复制源文件到Android源码里" class="headerlink" title="复制源文件到Android源码里"></a>复制源文件到Android源码里</h3><p>参考<a href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/">Android可执行文件imgui绘制</a>,区别就是编译成动态库(cc_library_shared),还要把zygisk头文件丢进去.<br><img src="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/vscode.jpg"><br>文件结构如上图.</p>
<h3 id="过滤到包名-多线程创建imgui"><a href="#过滤到包名-多线程创建imgui" class="headerlink" title="过滤到包名,多线程创建imgui"></a>过滤到包名,多线程创建imgui</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void postAppSpecialize(const AppSpecializeArgs *args) override</span><br><span class="line">&#123;</span><br><span class="line">    // Use JNI to fetch our process name</span><br><span class="line">    const char *process = env-&gt;GetStringUTFChars(args-&gt;nice_name, nullptr);</span><br><span class="line">    if (init(process) == false)</span><br><span class="line">    &#123;</span><br><span class="line">        //没有找到游戏</span><br><span class="line">        api-&gt;setOption(zygisk::Option::DLCLOSE_MODULE_LIBRARY);</span><br><span class="line">    &#125;</span><br><span class="line">    env-&gt;ReleaseStringUTFChars(args-&gt;nice_name, process);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">bool init(const char *process)</span><br><span class="line">&#123;</span><br><span class="line">    // LOGD(&quot;example: process=[%s]&quot;, process);</span><br><span class="line">    if (strcmp(hook_pkg_name, process) == 0)</span><br><span class="line">    &#123;</span><br><span class="line">        pthread_t ntid;</span><br><span class="line">        if (pthread_create(&amp;ntid, nullptr, startImGui, nullptr))</span><br><span class="line">        &#123;</span><br><span class="line">            LOGD(&quot;can&#x27;t create thread&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里startImGui的代码和<a href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/">Android可执行文件imgui绘制</a>代码一致.</p>
<h3 id="观察结果"><a href="#观察结果" class="headerlink" title="观察结果"></a>观察结果</h3><p>然后你会发现完全没有效果,但这并不意味着创建surface失败了,因为如果你打印surface的地址,会发现是有值的,如果你在tick打印日志,会发现日志会一直有输出.<br><img src="/2022/04/15/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%BA%8C/log.jpg"><br>为啥会这样呢?</p>
<p>见<a href="https://pshocker.github.io/2022/04/16/Magisk%E6%B3%A8%E5%85%A5app%E5%B9%B6%E5%B5%8C%E5%85%A5imgui-%E4%B8%89/">Magisk注入app并嵌入imgui(三)</a>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://pshocker.github.io/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/test.png">
      <meta itemprop="name" content="Shocker">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shocker">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/" class="post-title-link" itemprop="url">Android可执行文件imgui绘制</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-15 21:49:47" itemprop="dateCreated datePublished" datetime="2022-04-15T21:49:47+08:00">2022-04-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-12 11:16:59" itemprop="dateModified" datetime="2022-05-12T11:16:59+08:00">2022-05-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前我在<a href="https://pshocker.github.io/2022/03/23/Android%E5%A4%96%E9%83%A8imgui%E7%BB%98%E5%88%B6-%E4%BA%8C/">Android外部imgui绘制(二)</a>里说过</p>
<p><strong>在Android外部imgui绘制(一)里介绍了怎么实现一个外部imgui,其实还有一种方法,就是在aosp环境下编译一个可执行文件出来,有点类似于</strong><br><strong>可执行文件+skia绘制</strong><br><strong>但这个其实很麻烦,需要下载android源码(100多g),然后还要自己编译,最后还得修改代码.所以不太建议这么做.虽然效率可能确实会有提升.</strong><br><strong>好吧,我来填坑了.</strong></p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><h3 id="下载Android12-编译Android12"><a href="#下载Android12-编译Android12" class="headerlink" title="下载Android12,编译Android12."></a>下载Android12,编译Android12.</h3><p>这些网上有很多教学,值得一提的是,相比Android5,新版本编译的时候没有什么错误,基本上一次过.很爽.</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/grackergao/article/details/120984766">Android 系统开发系列（1）：Android 12 源代码下载、编译和刷机</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68918808">死磕Android_AOSP编译过程</a></p>
<p><strong>注意:硬盘剩余空间一定要大于250g,硬盘剩余空间一定要大于250g,硬盘剩余空间一定要大于250g</strong><br><strong>否则失败了会很麻烦.</strong></p>
<h3 id="复制源文件到Android源码里"><a href="#复制源文件到Android源码里" class="headerlink" title="复制源文件到Android源码里"></a>复制源文件到Android源码里</h3><p>把imgui的相关代码丢到external里.</p>
<p><img src="/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/vscode.jpg"><br>文件结构如上图.</p>
<h3 id="imgui"><a href="#imgui" class="headerlink" title="imgui"></a>imgui</h3><p>1.新建SurfaceComposerClient,并从SurfaceComposerClient中创建surface,这个SurfaceComposerClient其实是surfaceflinger进程的代理对象.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;SurfaceComposerClient&gt; client = new SurfaceComposerClient();</span><br><span class="line">sp&lt;IBinder&gt; mDisplay = SurfaceComposerClient::getInternalDisplayToken();</span><br><span class="line"></span><br><span class="line">ui::DisplayMode mode;</span><br><span class="line">status_t result = SurfaceComposerClient::getActiveDisplayMode(mDisplay, &amp;mode);</span><br><span class="line"></span><br><span class="line">sp&lt;SurfaceControl&gt; control = client-&gt;createSurface(</span><br><span class="line">        String8(&quot;Shocker&quot;),</span><br><span class="line">        mode.resolution.getWidth(),</span><br><span class="line">        mode.resolution.getHeight(),</span><br><span class="line">        PIXEL_FORMAT_RGBA_8888,</span><br><span class="line">        ISurfaceComposerClient::eFXSurfaceBufferState,</span><br><span class="line">        nullptr);</span><br></pre></td></tr></table></figure>
<p>这其实非常重要,对于imgui来说,它只需要绑定一个窗口(NativeWindow),就可以在上面绘制.</p>
<p>2.获取NativeWindow,绑定到imgui上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sp&lt;Surface&gt; mSurface = control-&gt;getSurface();</span><br><span class="line">sp&lt;ANativeWindow&gt; mANW = mSurface;</span><br><span class="line">ANativeWindow *g_EglNativeWindowType(mANW.get());</span><br><span class="line">LOGD(&quot;initSurface finish&quot;);</span><br><span class="line">LOGD(&quot;g_EglNativeWindowType:%llx&quot;, g_EglNativeWindowType);</span><br><span class="line"></span><br><span class="line">init(g_EglNativeWindowType);</span><br></pre></td></tr></table></figure>
<p>3.imgui初始化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">void init(ANativeWindow *g_EglNativeWindowType)</span><br><span class="line">&#123;</span><br><span class="line">    if (g_Initialized)</span><br><span class="line">        return;</span><br><span class="line"></span><br><span class="line">    ANativeWindow_acquire(g_EglNativeWindowType);</span><br><span class="line">............................</span><br><span class="line">(把源码里的g_App-&gt;window全部替换成g_EglNativeWindowType,其余不变)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.imgui循环渲染</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">while (true)</span><br><span class="line">&#123;</span><br><span class="line">    handleInputEvent(); //处理触摸事件,获取触摸可以参考我之前的文章.</span><br><span class="line">    tick(); //渲染画面</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最后一点"><a href="#最后一点" class="headerlink" title="最后一点"></a>最后一点</h2><p>安卓12要用Android.bp文件来编写编译文件,貌似之前的Android.mk可以用,但有bug.<br>附上我编译imgui用的Android.bp文件.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cc_binary &#123;</span><br><span class="line">    name: &quot;ImGuiTest&quot;,</span><br><span class="line">    srcs: [&quot;src/**/*.cpp&quot;],</span><br><span class="line"></span><br><span class="line">    local_include_dirs: [</span><br><span class="line">        &quot;src&quot;,</span><br><span class="line">        &quot;src/imgui&quot;,</span><br><span class="line">        &quot;src/backends&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    cppflags: [</span><br><span class="line">        &quot;-Wno-error&quot;,</span><br><span class="line">        &quot;-Wno-sign-conversion&quot;,</span><br><span class="line">        &quot;-Wno-unused-parameter&quot;,</span><br><span class="line">        &quot;-Wno-sign-conversion&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    shared_libs: [</span><br><span class="line">        &quot;liblog&quot;,</span><br><span class="line">        &quot;libandroid&quot;,</span><br><span class="line">        &quot;libgui&quot;,</span><br><span class="line">        &quot;libEGL&quot;,</span><br><span class="line">        &quot;libGLESv2&quot;,</span><br><span class="line">        &quot;libbinder&quot;,</span><br><span class="line">        &quot;libui&quot;,</span><br><span class="line">        &quot;libutils&quot;,</span><br><span class="line">        &quot;libinput&quot;,</span><br><span class="line">        &quot;libinputflinger&quot;,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2022/04/15/Android%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6imgui%E7%BB%98%E5%88%B6/imgui.jpg"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Shocker"
      src="/images/test.png">
  <p class="site-author-name" itemprop="name">Shocker</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://github.com/PShocker" title="https:&#x2F;&#x2F;github.com&#x2F;PShocker" rel="noopener" target="_blank">Title</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shocker</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


</body>
</html>
